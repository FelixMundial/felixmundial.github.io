<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Redis基础 | Felix Mundial的杂烩图书馆</title>
    <meta name="generator" content="VuePress 1.7.1">
    <link rel="icon" href="/icons/favicon.png">
    <meta name="description" content="github page powered by Vuepress">
    
    <link rel="preload" href="/assets/css/0.styles.0e3647e7.css" as="style"><link rel="preload" href="/assets/js/app.9bbd0500.js" as="script"><link rel="preload" href="/assets/js/1.7e1accfd.js" as="script"><link rel="preload" href="/assets/js/13.b5619b2f.js" as="script"><link rel="preload" href="/assets/js/18.ccf124a3.js" as="script"><link rel="prefetch" href="/assets/js/10.535b18bf.js"><link rel="prefetch" href="/assets/js/11.9f4c7505.js"><link rel="prefetch" href="/assets/js/12.1040a13c.js"><link rel="prefetch" href="/assets/js/14.9065f59b.js"><link rel="prefetch" href="/assets/js/15.1af3a730.js"><link rel="prefetch" href="/assets/js/16.145ee41f.js"><link rel="prefetch" href="/assets/js/17.daef2d0a.js"><link rel="prefetch" href="/assets/js/19.3c9e19e5.js"><link rel="prefetch" href="/assets/js/20.cbce51c7.js"><link rel="prefetch" href="/assets/js/21.aad032a5.js"><link rel="prefetch" href="/assets/js/22.d26d3f4d.js"><link rel="prefetch" href="/assets/js/23.36d5eb9b.js"><link rel="prefetch" href="/assets/js/24.3d224717.js"><link rel="prefetch" href="/assets/js/25.e67e5f2e.js"><link rel="prefetch" href="/assets/js/26.26226ddd.js"><link rel="prefetch" href="/assets/js/27.ef309e27.js"><link rel="prefetch" href="/assets/js/28.275159e4.js"><link rel="prefetch" href="/assets/js/29.f7f84fc3.js"><link rel="prefetch" href="/assets/js/3.92bf9476.js"><link rel="prefetch" href="/assets/js/4.7de240dc.js"><link rel="prefetch" href="/assets/js/5.422f2530.js"><link rel="prefetch" href="/assets/js/6.9952df18.js"><link rel="prefetch" href="/assets/js/7.b57f400b.js"><link rel="prefetch" href="/assets/js/8.a18e3f05.js"><link rel="prefetch" href="/assets/js/9.c6f1e43f.js">
    <link rel="stylesheet" href="/assets/css/0.styles.0e3647e7.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="azure" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name"><i class="el-icon-bicycle"></i> Felix Mundial的杂烩图书馆</span></a> <div class="links"><nav class="nav-links can-hide"><div class="nav-item"><a href="/guide/toc.html" class="nav-link" data-v-c7dec8ac><i class="el-icon-discount"></i> Archives</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">算法</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/posts/leetcode/leetcode101.html" class="nav-link" data-v-c7dec8ac><i class="iconfont icon-leetcode"></i> Leetcode</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont icon-java"></i> Java</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/posts/java/concurrency.html" class="nav-link" data-v-c7dec8ac>并发</a></li><li class="dropdown-item"><!----> <a href="/posts/java/jvm.html" class="nav-link" data-v-c7dec8ac>JVM</a></li><li class="dropdown-item"><!----> <a href="/posts/java/spring.html" class="nav-link" data-v-c7dec8ac>Spring</a></li><li class="dropdown-item"><!----> <a href="/posts/java/springmvc.html" class="nav-link" data-v-c7dec8ac>Spring MVC</a></li><li class="dropdown-item"><!----> <a href="/posts/java/springboot.html" class="nav-link" data-v-c7dec8ac>Spring Boot</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont icon-database"></i> 数据库</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/posts/database/mysql.html" class="nav-link" data-v-c7dec8ac><i class="iconfont icon-mysql"></i> MySQL</a></li><li class="dropdown-item"><!----> <a href="/posts/database/redis.html" aria-current="page" class="nav-link router-link-exact-active router-link-active" data-v-c7dec8ac><i class="iconfont icon-redis"></i> Redis</a></li></ul></div></div> <!----></nav> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/guide/toc.html" class="nav-link" data-v-c7dec8ac><i class="el-icon-discount"></i> Archives</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">算法</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/posts/leetcode/leetcode101.html" class="nav-link" data-v-c7dec8ac><i class="iconfont icon-leetcode"></i> Leetcode</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont icon-java"></i> Java</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/posts/java/concurrency.html" class="nav-link" data-v-c7dec8ac>并发</a></li><li class="dropdown-item"><!----> <a href="/posts/java/jvm.html" class="nav-link" data-v-c7dec8ac>JVM</a></li><li class="dropdown-item"><!----> <a href="/posts/java/spring.html" class="nav-link" data-v-c7dec8ac>Spring</a></li><li class="dropdown-item"><!----> <a href="/posts/java/springmvc.html" class="nav-link" data-v-c7dec8ac>Spring MVC</a></li><li class="dropdown-item"><!----> <a href="/posts/java/springboot.html" class="nav-link" data-v-c7dec8ac>Spring Boot</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont icon-database"></i> 数据库</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/posts/database/mysql.html" class="nav-link" data-v-c7dec8ac><i class="iconfont icon-mysql"></i> MySQL</a></li><li class="dropdown-item"><!----> <a href="/posts/database/redis.html" aria-current="page" class="nav-link router-link-exact-active router-link-active" data-v-c7dec8ac><i class="iconfont icon-redis"></i> Redis</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Database</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/posts/database/mysql.html" class="sidebar-link">MySQL基础</a></li><li><a href="/posts/database/redis.html" aria-current="page" class="active sidebar-link">Redis基础</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/posts/database/redis.html#使用场景" class="sidebar-link">使用场景</a></li><li class="sidebar-sub-header"><a href="/posts/database/redis.html#数据类型" class="sidebar-link">数据类型</a></li><li class="sidebar-sub-header"><a href="/posts/database/redis.html#通用命令" class="sidebar-link">通用命令</a></li><li class="sidebar-sub-header"><a href="/posts/database/redis.html#持久化" class="sidebar-link">持久化</a></li><li class="sidebar-sub-header"><a href="/posts/database/redis.html#事务" class="sidebar-link">事务</a></li><li class="sidebar-sub-header"><a href="/posts/database/redis.html#删除策略与淘汰算法" class="sidebar-link">删除策略与淘汰算法</a></li><li class="sidebar-sub-header"><a href="/posts/database/redis.html#高可用" class="sidebar-link">高可用</a></li><li class="sidebar-sub-header"><a href="/posts/database/redis.html#底层原理" class="sidebar-link">底层原理</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="post-header" data-v-528c0c8a><h2 class="post-title" data-v-528c0c8a><a href="/posts/database/redis.html" data-v-528c0c8a><!---->
			Redis基础
		</a></h2> <div class="post-meta" data-v-528c0c8a><div class="author post-meta-item" data-v-528c0c8a><i class="el-icon-bicycle" data-v-528c0c8a></i> <span data-v-528c0c8a>FelixMundial</span></div> <div class="time post-meta-item" data-v-528c0c8a><i class="el-icon-time" data-v-528c0c8a></i> <time data-v-528c0c8a>2020-10-28</time></div> <div class="category post-meta-item" data-v-528c0c8a><i class="el-icon-collection" data-v-528c0c8a></i> <a href="/category/Redis" class="category-item" data-v-528c0c8a>
				Redis
			</a></div> <div class="tags post-meta-item" data-v-528c0c8a><i class="el-icon-price-tag" data-v-528c0c8a></i> <span class="tag-item el-tag el-tag--light" data-v-528c0c8a>
				Redis
			</span></div> <div id="/posts/database/redis.html" data-flag-title="Redis基础" class="leancloud-visitors post-meta-item" data-v-528c0c8a><i class="el-icon-reading" data-v-528c0c8a></i> <span class="leancloud-visitors-count" data-v-528c0c8a>0</span></div></div></div> <div class="theme-default-content content__default"><h2 id="使用场景"><a href="#使用场景" class="header-anchor">#</a> 使用场景</h2> <ul><li><p>高性能</p> <p>提高后续请求的响应时间</p></li> <li><p>高并发</p> <p>分流请求，将大部分请求路由至缓存处理</p></li></ul> <h2 id="数据类型"><a href="#数据类型" class="header-anchor">#</a> 数据类型</h2> <h3 id="string"><a href="#string" class="header-anchor">#</a> String</h3> <h5 id="数据要求"><a href="#数据要求" class="header-anchor">#</a> 数据要求</h5> <p>键值可以为任何数据（最大为512M）【如jpeg图像或序列化的对象】</p> <h5 id="常用操作"><a href="#常用操作" class="header-anchor">#</a> 常用操作</h5> <h6 id="增删改查"><a href="#增删改查" class="header-anchor">#</a> 增删改查</h6> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token builtin class-name">set</span> <span class="token operator">&lt;</span>key<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>value<span class="token operator">&gt;</span>
OK

<span class="token operator">&gt;</span> get <span class="token operator">&lt;</span>key<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>value<span class="token operator">&gt;</span> / <span class="token punctuation">(</span>nil<span class="token punctuation">)</span>

<span class="token operator">&gt;</span> del <span class="token operator">&lt;</span>key<span class="token operator">&gt;</span>
<span class="token punctuation">(</span>Integer<span class="token punctuation">)</span> <span class="token number">1</span>/<span class="token punctuation">(</span>Integer<span class="token punctuation">)</span> <span class="token number">0</span>

<span class="token operator">&gt;</span> mset <span class="token operator">&lt;</span>key<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span> <span class="token operator">&lt;</span>value<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span> <span class="token operator">&lt;</span>key<span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span> <span class="token operator">&lt;</span>value<span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span> <span class="token punctuation">..</span>.
<span class="token operator">&gt;</span> mget <span class="token operator">&lt;</span>key<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span> <span class="token operator">&lt;</span>key<span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span>
</code></pre></div><h6 id="字符串操作"><a href="#字符串操作" class="header-anchor">#</a> 字符串操作</h6> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> strlen <span class="token operator">&lt;</span>key<span class="token operator">&gt;</span>
<span class="token operator">&gt;</span> append <span class="token operator">&lt;</span>key<span class="token operator">&gt;</span>
<span class="token operator">&gt;</span> getrange <span class="token operator">&lt;</span>key<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>pos<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span> <span class="token operator">&lt;</span>pos<span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span> <span class="token comment"># 双闭区间截取（java中对应方法为开闭截取）</span>
</code></pre></div><h6 id="特殊操作"><a href="#特殊操作" class="header-anchor">#</a> 特殊操作</h6> <ul><li><p>数值自增</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> incr <span class="token operator">&lt;</span>key<span class="token operator">&gt;</span>
<span class="token operator">&gt;</span> incrby <span class="token operator">&lt;</span>key<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>increment<span class="token operator">&gt;</span>
<span class="token operator">&gt;</span> incrbyfloat <span class="token operator">&lt;</span>key<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>increment<span class="token operator">&gt;</span>
</code></pre></div><blockquote><p>若数据不能转换为数值，或运算结果超出<code>Long.MAX_VALUE</code>，则报错</p></blockquote></li> <li><p>设置数据生命周期</p></li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> setex <span class="token operator">&lt;</span>key<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>ttl<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>val<span class="token operator">&gt;</span>
<span class="token operator">&gt;</span> psetex <span class="token operator">&lt;</span>key<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>ttl<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>val<span class="token operator">&gt;</span>
</code></pre></div><blockquote><p><code>java.String.substring()</code>方法为左闭右开区间截取</p></blockquote> <h5 id="应用场景"><a href="#应用场景" class="header-anchor">#</a> 应用场景</h5> <p>多用于数据整体存取</p> <ul><li><p>存储结构型或非结构型热点数据</p> <blockquote><p>数据key命名规范：</p> <ol start="2"><li><code>set &lt;表名&gt;:&lt;主键名&gt;:&lt;主键值&gt; &lt;多字段JSON对象&gt;</code></li> <li><code>set &lt;表名&gt;:&lt;主键名&gt;:&lt;主键值&gt;:&lt;字段名&gt; &lt;字段值&gt;</code>（性能较优）</li></ol></blockquote></li> <li><p>用作RDBMS分表主键生成策略（分批生成，无需考虑并发问题）</p></li></ul> <h3 id="hash"><a href="#hash" class="header-anchor">#</a> Hash</h3> <h5 id="数据要求-2"><a href="#数据要求-2" class="header-anchor">#</a> 数据要求</h5> <p>底层为哈希表（<code>field</code>-<code>value</code>），哈希值只能为字符串</p> <h5 id="常用操作-2"><a href="#常用操作-2" class="header-anchor">#</a> 常用操作</h5> <h6 id="增删改查-2"><a href="#增删改查-2" class="header-anchor">#</a> 增删改查</h6> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> hset <span class="token operator">&lt;</span>key<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>field<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>value<span class="token operator">&gt;</span>
<span class="token punctuation">(</span>Integer<span class="token punctuation">)</span> <span class="token number">1</span> / <span class="token punctuation">(</span>Integer<span class="token punctuation">)</span> <span class="token number">0</span> <span class="token comment"># 1表示field数目变化，0表示不变（不论失败与否）</span>

<span class="token operator">&gt;</span> hget <span class="token operator">&lt;</span>key<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>field<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>value<span class="token operator">&gt;</span> / <span class="token punctuation">(</span>nil<span class="token punctuation">)</span>

<span class="token operator">&gt;</span> hdel <span class="token operator">&lt;</span>key<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>field<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span> <span class="token punctuation">[</span>field2<span class="token punctuation">]</span> <span class="token punctuation">..</span>.
<span class="token punctuation">(</span>Integer<span class="token punctuation">)</span> <span class="token number">1</span> / <span class="token punctuation">(</span>Integer<span class="token punctuation">)</span> <span class="token number">0</span>

<span class="token operator">&gt;</span> hgetall <span class="token operator">&lt;</span>key<span class="token operator">&gt;</span>

<span class="token operator">&gt;</span> hmset <span class="token operator">&lt;</span>key<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>field<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span> <span class="token operator">&lt;</span>value<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span> <span class="token operator">&lt;</span>field<span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span> <span class="token operator">&lt;</span>value<span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span> <span class="token punctuation">..</span>.
<span class="token operator">&gt;</span> hmget <span class="token operator">&lt;</span>key<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>field<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span> <span class="token operator">&lt;</span>field<span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span> <span class="token punctuation">..</span>.
</code></pre></div><h6 id="集合操作"><a href="#集合操作" class="header-anchor">#</a> 集合操作</h6> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> hlen <span class="token operator">&lt;</span>key<span class="token operator">&gt;</span>
<span class="token punctuation">(</span>Integer<span class="token punctuation">)</span> x
<span class="token operator">&gt;</span> hexists <span class="token operator">&lt;</span>key<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>field<span class="token operator">&gt;</span>
<span class="token punctuation">(</span>Integer<span class="token punctuation">)</span> <span class="token number">1</span> / <span class="token punctuation">(</span>Integer<span class="token punctuation">)</span> <span class="token number">0</span>

<span class="token operator">&gt;</span> hkeys <span class="token operator">&lt;</span>key<span class="token operator">&gt;</span>

<span class="token operator">&gt;</span> hvals <span class="token operator">&lt;</span>key<span class="token operator">&gt;</span>

<span class="token operator">&gt;</span> hsetnx <span class="token operator">&lt;</span>key<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>field<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>value<span class="token operator">&gt;</span>
<span class="token punctuation">(</span>Integer<span class="token punctuation">)</span> <span class="token number">1</span> / <span class="token punctuation">(</span>Integer<span class="token punctuation">)</span> <span class="token number">0</span> <span class="token comment"># 1表示成功，0表示失败</span>
</code></pre></div><h6 id="特殊操作-2"><a href="#特殊操作-2" class="header-anchor">#</a> 特殊操作</h6> <ul><li>数值自增</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> hincrby <span class="token operator">&lt;</span>key<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>field<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>increment<span class="token operator">&gt;</span>
<span class="token operator">&gt;</span> hincrbyfloat <span class="token operator">&lt;</span>key<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>field<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>increment<span class="token operator">&gt;</span>
</code></pre></div><h5 id="注意事项"><a href="#注意事项" class="header-anchor">#</a> 注意事项</h5> <ul><li>相比于String操作，内存与CPU消耗更低</li> <li>Hash中每个key最多可以存储2^32-1个键值对，不可将Hash作为对象列表滥用</li> <li>当Hash中key未达到阈值或单个元素较小时，底层为Ziplist，按插入顺序进行紧密存储；若Hash中key过多，底层转换为哈希，数据改为无序排列，遍历所有field的效率很低，此时应将key进行分片存储</li></ul> <h5 id="应用场景-2"><a href="#应用场景-2" class="header-anchor">#</a> 应用场景</h5> <p>多用于同类数据的归类整合与数据的局部更新</p> <ul><li><p>存储购物车数据</p> <p>以用户id为key，针对每位用户创建Hash，并以商品id作为field，商品加车数量作为value进行存储</p> <blockquote><p>同时额外维护商品信息Hash进行解耦，使用<code>setnx</code>更新商品信息</p></blockquote></li> <li><p>存储抢购、限购时的商品数量</p> <p>以商家id为key，商品id作为field，商品剩余数量作为value进行存储</p> <blockquote><p>超卖问题</p></blockquote></li></ul> <h3 id="list"><a href="#list" class="header-anchor">#</a> List</h3> <h5 id="数据要求-3"><a href="#数据要求-3" class="header-anchor">#</a> 数据要求</h5> <p>底层为双向链表，元素必须为<strong>字符串</strong>；可实现双端队列操作</p> <h5 id="常用操作-3"><a href="#常用操作-3" class="header-anchor">#</a> 常用操作</h5> <h6 id="增删改查-3"><a href="#增删改查-3" class="header-anchor">#</a> 增删改查</h6> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> lpush <span class="token operator">&lt;</span>key<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>value<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span> <span class="token punctuation">[</span><span class="token operator">&lt;</span>value<span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span> <span class="token punctuation">..</span>.<span class="token punctuation">]</span>
<span class="token punctuation">(</span>Integer<span class="token punctuation">)</span> x
<span class="token operator">&gt;</span> rpush <span class="token operator">&lt;</span>key<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>value<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span> <span class="token punctuation">[</span><span class="token operator">&lt;</span>value<span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span> <span class="token punctuation">..</span>.<span class="token punctuation">]</span>
<span class="token punctuation">(</span>Integer<span class="token punctuation">)</span> x

<span class="token operator">&gt;</span> lrange <span class="token operator">&lt;</span>key<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>start<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>end<span class="token operator">&gt;</span> <span class="token comment"># end为-1时遍历全部元素</span>
<span class="token operator">&gt;</span> lindex <span class="token operator">&lt;</span>key<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>index<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>value<span class="token operator">&gt;</span> / <span class="token punctuation">(</span>nil<span class="token punctuation">)</span>

<span class="token operator">&gt;</span> lpop <span class="token operator">&lt;</span>key<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>value<span class="token operator">&gt;</span> / <span class="token punctuation">(</span>nil<span class="token punctuation">)</span>
<span class="token operator">&gt;</span> rpop <span class="token operator">&lt;</span>key<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>value<span class="token operator">&gt;</span> / <span class="token punctuation">(</span>nil<span class="token punctuation">)</span>

<span class="token operator">&gt;</span> lrem <span class="token operator">&lt;</span>key<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>count<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>value<span class="token operator">&gt;</span>
<span class="token punctuation">(</span>Integer<span class="token punctuation">)</span> x
</code></pre></div><h6 id="集合操作-2"><a href="#集合操作-2" class="header-anchor">#</a> 集合操作</h6> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> llen <span class="token operator">&lt;</span>key<span class="token operator">&gt;</span>
<span class="token punctuation">(</span>Integer<span class="token punctuation">)</span> x
</code></pre></div><h6 id="特殊操作-3"><a href="#特殊操作-3" class="header-anchor">#</a> 特殊操作</h6> <ul><li>阻塞式出列</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> blpop <span class="token operator">&lt;</span>key<span class="token operator">&gt;</span> <span class="token punctuation">[</span><span class="token operator">&lt;</span>key<span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span> <span class="token punctuation">..</span>.<span class="token punctuation">]</span> <span class="token operator">&lt;</span>timeout<span class="token operator">&gt;</span>
<span class="token operator">&gt;</span> brpop <span class="token operator">&lt;</span>key<span class="token operator">&gt;</span> <span class="token punctuation">[</span><span class="token operator">&lt;</span>key<span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span> <span class="token punctuation">..</span>.<span class="token punctuation">]</span> <span class="token operator">&lt;</span>timeout<span class="token operator">&gt;</span>
</code></pre></div><blockquote><p>阻塞轮询场景下的异常处理</p> <ol><li><code>brpoplpush</code>将目标list中数据出队，并加入备份list</li> <li>发生异常时，<code>blpoprpush</code>将备份list中数据还原回目标list；不发生异常时，<code>blpop</code>移除备份list中数据</li></ol></blockquote> <h5 id="注意事项-2"><a href="#注意事项-2" class="header-anchor">#</a> 注意事项</h5> <ul><li>作为链表，数据读取速度较慢</li> <li>每个key最多可以存储2^32-1个元素</li></ul> <h5 id="应用场景-3"><a href="#应用场景-3" class="header-anchor">#</a> 应用场景</h5> <ul><li><p>存储朋友圈点赞顺序、社交网站关注列表信息等</p> <blockquote><p>使用<code>rpush</code>添加点赞，<code>lrem</code>移除点赞，<code>lrange</code>遍历点赞名单，<code>lindex</code>获取点赞状态（用户是否已点赞）</p></blockquote></li> <li><p>存储信息聚合类网站待推送博文等<strong>热点信息</strong></p> <blockquote><p><strong>普通博文</strong></p> <p>（对于每一关注者）使用<code>rpush</code>添加待推送博文，<code>lrange</code>遍历待推送博文</p> <p><strong>大V博文</strong></p></blockquote></li> <li><p>存储多台服务器先后输出的日志等严格区分操作顺序的数据信息（<strong>可持久化</strong>）</p></li></ul> <h3 id="set"><a href="#set" class="header-anchor">#</a> Set</h3> <h5 id="数据要求-4"><a href="#数据要求-4" class="header-anchor">#</a> 数据要求</h5> <p>底层为value值为空的Hash（<code>Map&lt;String, null&gt;</code>）；查找元素复杂度为O(1)</p> <h5 id="常用操作-4"><a href="#常用操作-4" class="header-anchor">#</a> 常用操作</h5> <h6 id="增删改查-4"><a href="#增删改查-4" class="header-anchor">#</a> 增删改查</h6> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> sadd <span class="token operator">&lt;</span>key<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>member<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span> <span class="token punctuation">[</span><span class="token operator">&lt;</span>member<span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span> <span class="token punctuation">..</span>.<span class="token punctuation">]</span>
<span class="token punctuation">(</span>Integer<span class="token punctuation">)</span> <span class="token number">1</span> / <span class="token punctuation">(</span>Integer<span class="token punctuation">)</span> <span class="token number">0</span> <span class="token comment"># 1表示元素数目变化，0表示不变（不论失败与否）</span>

<span class="token operator">&gt;</span> smembers <span class="token operator">&lt;</span>key<span class="token operator">&gt;</span>

<span class="token operator">&gt;</span> srem <span class="token operator">&lt;</span>key<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>member<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span> <span class="token punctuation">[</span><span class="token operator">&lt;</span>member<span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span> <span class="token punctuation">..</span>.<span class="token punctuation">]</span>

</code></pre></div><h6 id="集合操作-3"><a href="#集合操作-3" class="header-anchor">#</a> 集合操作</h6> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> scard <span class="token operator">&lt;</span>key<span class="token operator">&gt;</span>
<span class="token punctuation">(</span>Integer<span class="token punctuation">)</span> x
<span class="token operator">&gt;</span> sismember <span class="token operator">&lt;</span>key<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>member<span class="token operator">&gt;</span>
<span class="token punctuation">(</span>Integer<span class="token punctuation">)</span> <span class="token number">1</span> / <span class="token punctuation">(</span>Integer<span class="token punctuation">)</span> <span class="token number">0</span>
</code></pre></div><p>特殊操作</p> <ul><li><p>移动元素</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> smove <span class="token operator">&lt;</span>src<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>dest<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>member<span class="token operator">&gt;</span>
</code></pre></div></li> <li><p>随机获取元素</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> srandmember <span class="token operator">&lt;</span>key<span class="token operator">&gt;</span> <span class="token punctuation">[</span><span class="token operator">&lt;</span>count<span class="token operator">&gt;</span><span class="token punctuation">]</span>

<span class="token operator">&gt;</span> spop <span class="token operator">&lt;</span>key<span class="token operator">&gt;</span> <span class="token punctuation">[</span><span class="token operator">&lt;</span>count<span class="token operator">&gt;</span><span class="token punctuation">]</span>

</code></pre></div></li> <li><p>交并差集</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> sinter <span class="token operator">&lt;</span>key<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span> <span class="token operator">&lt;</span>key<span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span> <span class="token punctuation">..</span>.
<span class="token operator">&gt;</span> sunion <span class="token operator">&lt;</span>key<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span> <span class="token operator">&lt;</span>key<span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span> <span class="token punctuation">..</span>.
<span class="token operator">&gt;</span> <span class="token function">sdiff</span> <span class="token operator">&lt;</span>key<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span> <span class="token operator">&lt;</span>key<span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span> <span class="token punctuation">..</span>. <span class="token comment"># 具有方向性</span>

<span class="token operator">&gt;</span> sinterstore <span class="token operator">&lt;</span>dest<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>key<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span> <span class="token operator">&lt;</span>key<span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span> <span class="token punctuation">..</span>.
<span class="token operator">&gt;</span> sunionstore <span class="token operator">&lt;</span>dest<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>key<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span> <span class="token operator">&lt;</span>key<span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span> <span class="token punctuation">..</span>.
<span class="token operator">&gt;</span> sdiffstore <span class="token operator">&lt;</span>dest<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>key<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span> <span class="token operator">&lt;</span>key<span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span> <span class="token punctuation">..</span>.
</code></pre></div></li></ul> <h5 id="注意事项-3"><a href="#注意事项-3" class="header-anchor">#</a> 注意事项</h5> <ul><li>无法插入重复元素</li></ul> <h5 id="应用场景-4"><a href="#应用场景-4" class="header-anchor">#</a> 应用场景</h5> <ul><li><p>存储资讯或新媒体类网站用户兴趣等随机推荐信息</p> <blockquote><p>系统将热门分类信息存入Set，随机挑选出部分分类结合用户已关注信息合并推送给用户</p></blockquote></li> <li><p>存储同类信息的关联搜索与深度关联搜索等</p> <blockquote><p>共同关注：<code>sinter</code></p> <p>我关注的人也关注TA：<code>sismember</code>（大V场景优化）</p> <p>可能关注：<code>sdiff</code></p></blockquote></li> <li><p>用于同类型全局数据的快速去重（如网站UV/IP访问量）与快速定位（如网站黑白名单）</p></li> <li><p>存储抽奖用户信息</p> <blockquote><p><code>sadd</code>添加抽奖用户，<code>srandmember</code>/<code>spop</code>进行抽奖</p></blockquote></li></ul> <h3 id="zset"><a href="#zset" class="header-anchor">#</a> ZSet</h3> <h5 id="数据要求-5"><a href="#数据要求-5" class="header-anchor">#</a> 数据要求</h5> <p>底层为额外添加score字段的Set；查找元素复杂度为O(1)</p> <h5 id="常用操作-5"><a href="#常用操作-5" class="header-anchor">#</a> 常用操作</h5> <h6 id="增删改查-5"><a href="#增删改查-5" class="header-anchor">#</a> 增删改查</h6> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> zadd <span class="token operator">&lt;</span>key<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>score<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>member<span class="token operator">&gt;</span> <span class="token punctuation">[</span><span class="token operator">&lt;</span>score<span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span> <span class="token operator">&lt;</span>member<span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span> <span class="token punctuation">..</span>.<span class="token punctuation">]</span> <span class="token comment"># score值在前，value值在后</span>

<span class="token operator">&gt;</span> zrange <span class="token operator">&lt;</span>key<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>start<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>end<span class="token operator">&gt;</span> <span class="token punctuation">[</span>WITHSCORES<span class="token punctuation">]</span> <span class="token comment"># 按照score值从小到大进行排序</span>
<span class="token operator">&gt;</span> zrevrange <span class="token operator">&lt;</span>key<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>start<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>end<span class="token operator">&gt;</span> <span class="token punctuation">[</span>WITHSCORES<span class="token punctuation">]</span>

<span class="token operator">&gt;</span> zrem <span class="token operator">&lt;</span>key<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>member<span class="token operator">&gt;</span> <span class="token punctuation">[</span><span class="token operator">&lt;</span>member<span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span> <span class="token punctuation">..</span>.<span class="token punctuation">]</span>

<span class="token operator">&gt;</span> zpopmin <span class="token operator">&lt;</span>key<span class="token operator">&gt;</span> <span class="token punctuation">[</span><span class="token operator">&lt;</span>count<span class="token operator">&gt;</span><span class="token punctuation">]</span>
<span class="token operator">&gt;</span> zpopmax <span class="token operator">&lt;</span>key<span class="token operator">&gt;</span> <span class="token punctuation">[</span><span class="token operator">&lt;</span>count<span class="token operator">&gt;</span><span class="token punctuation">]</span>
</code></pre></div><h6 id="集合操作-4"><a href="#集合操作-4" class="header-anchor">#</a> 集合操作</h6> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> zcard <span class="token operator">&lt;</span>key<span class="token operator">&gt;</span>
<span class="token operator">&gt;</span> zcount <span class="token operator">&lt;</span>key<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>min<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>max<span class="token operator">&gt;</span>

<span class="token operator">&gt;</span> sinterstore <span class="token operator">&lt;</span>dest<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>numkeys<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>key<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span> <span class="token operator">&lt;</span>key<span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span> <span class="token punctuation">..</span>. <span class="token punctuation">[</span>AGGREGATE SUM<span class="token operator">|</span>MIN<span class="token operator">|</span>MAX<span class="token punctuation">]</span> <span class="token comment"># AGGREGATE参数表示交并差集操作后对符合条件元素score值的操作</span>
<span class="token operator">&gt;</span> sunionstore <span class="token operator">&lt;</span>dest<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>numkeys<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>key<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span> <span class="token operator">&lt;</span>key<span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span> <span class="token punctuation">..</span>. <span class="token punctuation">[</span>AGGREGATE SUM<span class="token operator">|</span>MIN<span class="token operator">|</span>MAX<span class="token punctuation">]</span>
<span class="token operator">&gt;</span> sdiffstore <span class="token operator">&lt;</span>dest<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>numkeys<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>key<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span> <span class="token operator">&lt;</span>key<span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span> <span class="token punctuation">..</span>. <span class="token punctuation">[</span>AGGREGATE SUM<span class="token operator">|</span>MIN<span class="token operator">|</span>MAX<span class="token punctuation">]</span>
</code></pre></div><h6 id="特殊操作-4"><a href="#特殊操作-4" class="header-anchor">#</a> 特殊操作</h6> <ul><li>根据score操作</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> zrank <span class="token operator">&lt;</span>key<span class="token operator">&gt;</span>
<span class="token operator">&gt;</span> zrevrank <span class="token operator">&lt;</span>key<span class="token operator">&gt;</span>

<span class="token operator">&gt;</span> zscore <span class="token operator">&lt;</span>key<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>member<span class="token operator">&gt;</span>

<span class="token operator">&gt;</span> zincrby <span class="token operator">&lt;</span>key<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>increment<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>member<span class="token operator">&gt;</span>

<span class="token operator">&gt;</span> zrangebyscore <span class="token operator">&lt;</span>key<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>min<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>max<span class="token operator">&gt;</span> <span class="token punctuation">[</span>WITHSCORES<span class="token punctuation">]</span> <span class="token punctuation">[</span>LIMIT <span class="token operator">&lt;</span>offset<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>count<span class="token operator">&gt;</span><span class="token punctuation">]</span>
<span class="token operator">&gt;</span> zrevrangebyscore <span class="token operator">&lt;</span>key<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>max<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>min<span class="token operator">&gt;</span> <span class="token punctuation">[</span>WITHSCORES<span class="token punctuation">]</span> <span class="token punctuation">[</span>LIMIT <span class="token operator">&lt;</span>offset<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>count<span class="token operator">&gt;</span><span class="token punctuation">]</span>

<span class="token operator">&gt;</span> zremrangebyrank <span class="token operator">&lt;</span>key<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>start<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>end<span class="token operator">&gt;</span> <span class="token punctuation">[</span>WITHSCORES<span class="token punctuation">]</span>
<span class="token operator">&gt;</span> zremrangebyscore <span class="token operator">&lt;</span>key<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>min<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>max<span class="token operator">&gt;</span> <span class="token punctuation">[</span>WITHSCORES<span class="token punctuation">]</span>
</code></pre></div><h5 id="注意事项-4"><a href="#注意事项-4" class="header-anchor">#</a> 注意事项</h5> <ul><li>能够插入相同元素，并导致该元素score值更新（返回<code>(Integer) 0</code>说明元素数目不变）</li> <li>score值作为整数，上限为2^64-1；作为浮点数，可能会有精度丢失</li></ul> <h5 id="应用场景-5"><a href="#应用场景-5" class="header-anchor">#</a> 应用场景</h5> <ul><li><p>存储排行榜（如热门直播、好友亲密度、热销商品、微博热搜等）数据并进行组合统计（<strong>可持久化</strong>）</p></li> <li><p>存储基础+增值类服务（如云盘、游戏或观影VIP等）的用户会员（体验会员）信息，或限时服务（如投票、私密讨论、限期优惠券等）信息）</p> <blockquote><ul><li>限时服务：将过期时间作为score，利用排序功能区分业务处理（如中止服务）的先后顺序，同时过期服务进行移除，并按照不同时间段逐级提升（如将一小时内即将逾期的服务加入ZSet进行处理，全部处理完后再加入下一小时即将逾期的服务）（<strong>可持久化</strong>）</li> <li>限次服务（无需按服务排序）：使用String，通过<code>setex uid:appid 60 1</code>初始化使用次数（如60s内使用x次），若<code>get</code>次数达到x次上限，则停止提供服务，特定时间段过后key过期，重新初始化计数（<strong>无需持久化</strong>）</li></ul></blockquote></li> <li><p>基本延时消息队列（将消息发布时间戳作为score）</p></li></ul> <h4 id="其他应用场景"><a href="#其他应用场景" class="header-anchor">#</a> 其他应用场景</h4> <ul><li><p>存储社交类应用所接收的用户消息等基于时间顺序的数据信息（<strong>可持久化</strong>）</p> <blockquote><p>先判断该消息是否在<strong>置顶Set</strong>中，选择<strong>置顶List</strong>或<strong>普通List</strong>，先移除List中的相同key，再重新插入；也可使用ZSet，score值维护消息最后发送的时刻</p></blockquote></li></ul> <blockquote><p>同时使用String或Hash计数器另行维护消息数目，与List进行同步更新</p></blockquote> <h3 id="bitmap"><a href="#bitmap" class="header-anchor">#</a> Bitmap</h3> <p><strong>应用场景</strong></p> <ul><li>统计日活用户等<strong>海量数据</strong></li></ul> <blockquote><p><code>setbit 2020:1021 1 1</code>记录id（id可进行偏移）为1的用户登录；<code>bitcount 2020:1021 0 -1</code>统计日活用户量（O(n)）</p></blockquote> <h2 id="通用命令"><a href="#通用命令" class="header-anchor">#</a> 通用命令</h2> <h5 id="基本操作"><a href="#基本操作" class="header-anchor">#</a> 基本操作</h5> <h6 id="key相关"><a href="#key相关" class="header-anchor">#</a> key相关</h6> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token builtin class-name">type</span> <span class="token operator">&lt;</span>key<span class="token operator">&gt;</span>
<span class="token operator">&gt;</span> exists <span class="token operator">&lt;</span>key<span class="token operator">&gt;</span>
<span class="token operator">&gt;</span> del <span class="token operator">&lt;</span>key<span class="token operator">&gt;</span>

<span class="token operator">&gt;</span> keys <span class="token operator">&lt;</span>pattern<span class="token operator">&gt;</span>

<span class="token operator">&gt;</span> <span class="token function">rename</span> <span class="token operator">&lt;</span>key<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>newKey<span class="token operator">&gt;</span>
<span class="token operator">&gt;</span> renamenx <span class="token operator">&lt;</span>key<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>newKey<span class="token operator">&gt;</span>

<span class="token operator">&gt;</span> <span class="token function">sort</span> <span class="token operator">&lt;</span>key<span class="token operator">&gt;</span>
</code></pre></div><h6 id="数据库相关"><a href="#数据库相关" class="header-anchor">#</a> 数据库相关</h6> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">&lt;</span>dbIndex<span class="token operator">&gt;</span>

<span class="token operator">&gt;</span> move <span class="token operator">&lt;</span>key<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>dbIndex<span class="token operator">&gt;</span> <span class="token comment"># 剪切操作</span>
</code></pre></div><h5 id="扩展操作"><a href="#扩展操作" class="header-anchor">#</a> 扩展操作</h5> <h6 id="key时效性控制"><a href="#key时效性控制" class="header-anchor">#</a> Key时效性控制</h6> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> expire <span class="token operator">&lt;</span>key<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>seconds<span class="token operator">&gt;</span>
<span class="token operator">&gt;</span> pexpire <span class="token operator">&lt;</span>key<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>milliseconds<span class="token operator">&gt;</span>
<span class="token operator">&gt;</span> expireat <span class="token operator">&lt;</span>key<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>timestamp<span class="token operator">&gt;</span>
<span class="token operator">&gt;</span> pexpireat <span class="token operator">&lt;</span>key<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>ptimestamp<span class="token operator">&gt;</span>

<span class="token operator">&gt;</span> ttl <span class="token operator">&lt;</span>key<span class="token operator">&gt;</span> <span class="token comment"># -2表示已过期，-1表示永不过期</span>
<span class="token operator">&gt;</span> pttl <span class="token operator">&lt;</span>key<span class="token operator">&gt;</span>

<span class="token operator">&gt;</span> persist <span class="token operator">&lt;</span>key<span class="token operator">&gt;</span>
<span class="token punctuation">(</span>Integer<span class="token punctuation">)</span> <span class="token number">1</span> / <span class="token punctuation">(</span>Integer<span class="token punctuation">)</span> <span class="token number">0</span>
</code></pre></div><h2 id="持久化"><a href="#持久化" class="header-anchor">#</a> 持久化</h2> <p><code>bgsave</code>原理</p> <ul><li><code>fork</code></li> <li><code>cow</code></li></ul> <h2 id="事务"><a href="#事务" class="header-anchor">#</a> 事务</h2> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> MULTI
<span class="token operator">&gt;</span> EXEC/DISCARD

<span class="token operator">&gt;</span> WATCH
</code></pre></div><h4 id=""><a href="#" class="header-anchor">#</a></h4> <h3 id="读操作"><a href="#读操作" class="header-anchor">#</a> 读操作</h3> <ul><li><h4 id="缓存穿透"><a href="#缓存穿透" class="header-anchor">#</a> 缓存穿透</h4> <p>策略：缓存空值</p></li> <li><h4 id="缓存雪崩"><a href="#缓存雪崩" class="header-anchor">#</a> 缓存雪崩</h4> <p>策略：为缓存key过期时间添加额外的随机增量</p></li> <li><h4 id="缓存击穿"><a href="#缓存击穿" class="header-anchor">#</a> 缓存击穿</h4> <ul><li><p><strong>本地锁</strong>（❌）</p> <p>根据缓存命中结果决定是否进入同步代码块，且在同步代码块头部再次判断缓存是否命中（<strong>双重检查</strong>）；在退出同步代码块前写入缓存，保证在下一线程进入同步代码块时缓存已同步</p></li> <li><h4 id="分布式锁"><a href="#分布式锁" class="header-anchor">#</a> 分布式锁</h4> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> SET LOCK_KEY <span class="token number">1</span> PX <span class="token operator">&lt;</span>MILLISECONDS<span class="token operator">&gt;</span> NX
<span class="token comment"># 如果成功获取锁</span>
<span class="token operator">&gt;</span> <span class="token punctuation">..</span>. <span class="token comment"># 执行业务操作</span>
<span class="token operator">&gt;</span> DEL LOCK_KEY <span class="token comment"># 释放锁</span>
</code></pre></div><blockquote><p>过期时间一般为：业务最大耗时✖️120%+平均网络耗时✖️110%（有隐患）</p></blockquote> <p><strong>改进</strong>：</p> <p>释放锁之前判断锁是否过期，同时是否是自己所设置的锁（如LOCK_KEY值为UUID），通过lua脚本保证该流程为原子操作</p> <div class="language-lua extra-class"><pre class="language-lua"><code><span class="token keyword">if</span> redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'get'</span><span class="token punctuation">,</span> KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> ARGV<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
<span class="token keyword">then</span>
  <span class="token keyword">return</span> redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'del'</span><span class="token punctuation">,</span> KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">else</span>
  <span class="token keyword">return</span> <span class="token number">0</span>
<span class="token keyword">end</span>
</code></pre></div></li></ul></li></ul> <h3 id="写操作"><a href="#写操作" class="header-anchor">#</a> 写操作</h3> <ul><li><h4 id="分布式锁-2"><a href="#分布式锁-2" class="header-anchor">#</a> 分布式锁</h4></li></ul> <blockquote><ol><li>互斥/排他性：在任意时刻，只有一个客户端能持有锁（<code>setnx</code>）</li> <li>不会发生死锁：即使有客户端在持锁期间由于崩溃而没有主动解锁，也能保证后续客户端加锁成功（主动释放；过期自动释放）</li> <li>容错性：只要大部分的Redis节点正常运行，客户端就能正常加锁和解锁</li> <li>解铃还须系铃人：加锁和解锁过程必须由同一个客户端执行，客户端A不能对客户端B所加的锁进行解锁（将value赋值为<code>requestId</code>，代表加锁客户端的唯一请求标识）</li></ol></blockquote> <h5 id="redisson"><a href="#redisson" class="header-anchor">#</a> Redisson</h5> <p>底层通过<strong>lua脚本</strong>实现所有操作的原子性</p> <ul><li><p><code>RLock</code>（可重入锁）</p> <p><code>RLock.lock(超时时间)</code></p> <ul><li><p>锁的自动续期</p> <p>若不指定锁对象的超时时间，则使用默认超时时间<code>lockWatchdogTimeout</code>为30s；一旦占锁成功，启动定时任务每10s（<code>internalLockLeaseTime</code>）执行一次续期脚本</p></li> <li><p><code>RReadWriteLock</code>（互斥锁/排他锁与共享锁）</p> <p>保证读操作能获取最新数据</p> <ul><li>并发读：同时获取读锁</li> <li>并发写/并发读写（读-写或写-读）：阻塞等待前一线程操作（占有读锁或写锁）成功</li></ul></li> <li><p><code>RSemaphore</code></p> <p>限量操作（通过对锁对象值的增减进行控制）</p> <blockquote><p>实现分布式限流</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// RSemaphore s;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">tryAcquire</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token comment">// s.release();</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token string">&quot;busy&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></blockquote></li> <li><p><code>RCountDownLatch</code></p></li></ul> <blockquote><p><strong>主从/集群架构故障转移时的锁失效问题</strong></p> <ul><li>Redlock多写</li></ul></blockquote></li> <li><h4 id="缓存一致性"><a href="#缓存一致性" class="header-anchor">#</a> 缓存一致性</h4> <blockquote><p>通用策略：根据数据时效性合理设置缓存过期时间，使所有的读操作最终以数据库为准（最终一致性）</p></blockquote> <ul><li><h5 id="双写-弃用"><a href="#双写-弃用" class="header-anchor">#</a> 双写（弃用）</h5> <p>数据更新时先写数据库再覆盖缓存（数据查询时，操作步骤均为先读数据库再写入缓存）</p> <blockquote><p>由于双写操作非原子操作，可能导致先更新DB的线程后更新缓存，从而造成缓存不一致</p> <p><strong>注意事项：</strong></p> <ul><li>双写过程加锁</li></ul></blockquote></li> <li><h5 id="cache-aside-后删"><a href="#cache-aside-后删" class="header-anchor">#</a> Cache Aside（后删）</h5> <p>数据更新时先写数据库再删缓存</p> <blockquote><p><strong>注意事项：</strong></p> <ul><li>后删过程加锁</li> <li>若写场景较多，且写入缓存值需经过计算获取，则可使用Cache Aside模式</li> <li><strong>若第二次未能成功删除缓存导致缓存不一致：</strong> <ul><li>将删除失败的<strong>缓存key</strong>或**MySQL binlog日志数据（借助Canal）**存至MQ以进行延时重试</li></ul></li></ul></blockquote></li> <li><h5 id="延迟双删"><a href="#延迟双删" class="header-anchor">#</a> 延迟双删</h5> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">Object</span> data<span class="token punctuation">)</span><span class="token punctuation">{</span>
	redis<span class="token punctuation">.</span><span class="token function">del</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
	db<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	redis<span class="token punctuation">.</span><span class="token function">del</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>数据更新时先淘汰缓存后写数据库再延迟（～1s）删缓存</p> <blockquote><p><strong>注意事项：</strong></p> <ul><li>第一次删除缓存目的：❓</li> <li>第二次延时删除缓存的目的：确保该时刻其他线程的写缓存操作已经结束，删除缓存后不会再有其他线程写入脏数据</li> <li>主备分离场景下，延时时间需由主备同步延时时间决定</li> <li>第二次删除缓存时开辟新线程进行异步操作，提高工作线程（写线程）吞吐量</li> <li>同样存在Cache Aside模式中淘汰缓存失败所造成的缓存不一致问题</li></ul></blockquote></li> <li><h6 id="操作串行化"><a href="#操作串行化" class="header-anchor">#</a> 操作串行化</h6> <ul><li>写操作：先删缓存，再将更新数据库的操作放入有序队列</li> <li>读操作：若缓存未命中，读操作也放入有序队列</li></ul> <blockquote><p>若读请求大量积压：</p> <ul><li>将任务队列水平拆分，提高并行度
<ul><li>使用适当的Hash一致性算法保证相同请求路由至相同队列中</li></ul></li> <li>合理配置限流与降级策略</li></ul></blockquote></li></ul> <blockquote><p><strong>缓存一致性场景分类</strong>：</p> <ol><li>低并发操作
<ol><li>基础数据（菜单分类等）：时效容忍度高，可设置较长的缓存过期时间等待数据稳定；也可借助Canal订阅MySQL binlog方式实现缓存数据同步</li> <li>用户纬度数据（订单数据、用户信息数据等）：并发低，可设置合理的缓存过期时间等待数据稳定</li></ol></li> <li>高并发操作</li></ol></blockquote></li></ul> <h2 id="删除策略与淘汰算法"><a href="#删除策略与淘汰算法" class="header-anchor">#</a> 删除策略与淘汰算法</h2> <h4 id="删除策略"><a href="#删除策略" class="header-anchor">#</a> 删除策略</h4> <ul><li>定时删除策略</li> <li>惰性删除策略：获取数据时若发现该数据已过期则进行删除</li> <li>定期删除策略：周期性（每隔100ms）随机抽查存储空间（<strong>随机、重点抽查</strong>）</li></ul> <p>可能导致缓存雪崩，需灵活配置不同数据的过期时间</p> <h4 id="淘汰-逐出算法"><a href="#淘汰-逐出算法" class="header-anchor">#</a> 淘汰/逐出算法</h4> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 最大可使用内存（60%～70%）</span>
<span class="token operator">&gt;</span> maxmemory
<span class="token comment"># 每次随机获取待删除数据的个数</span>
<span class="token operator">&gt;</span> maxmemory-samples
<span class="token comment"># 待删除数据的逐出算法</span>
<span class="token operator">&gt;</span> maxmemory-policy
</code></pre></div><h5 id="maxmemory-policy"><a href="#maxmemory-policy" class="header-anchor">#</a> <code>maxmemory-policy</code></h5> <ul><li>检测易失数据
<ul><li><code>volatile-lru</code></li> <li><code>volatile-lfu</code></li> <li><code>volatile-ttl</code></li> <li><code>volatile-random</code></li></ul></li> <li>检测全表数据
<ul><li><code>allkeys-lru</code></li> <li><code>allkeys-lfu</code></li> <li><code>allkeys-random</code></li></ul></li> <li>禁用
<ul><li><code>no-eviction</code></li></ul></li></ul> <blockquote><p>通过<code>INFO</code>信息中的<code>keyspace-hits</code>和<code>keyspace-misses</code>属性值判断当前Redis服务的性能，以选择合适的调优策略</p></blockquote> <h2 id="高可用"><a href="#高可用" class="header-anchor">#</a> 高可用</h2> <h3 id="主从"><a href="#主从" class="header-anchor">#</a> 主从</h3> <h6 id="工作流程"><a href="#工作流程" class="header-anchor">#</a> 工作流程</h6> <ol><li><p><strong>建立连接</strong></p> <ol><li>slave保存master的ip与端口信息（<code>slaveof &lt;ip&gt; &lt;port&gt;</code>）</li> <li>slave根据master信息创建连接master的socket，定时发送<code>ping</code>指令</li> <li>master保存slave的端口信息（<code>replconf listening-port &lt;port&gt;</code>）</li></ol></li> <li><p><strong>数据同步</strong></p> <ol><li><p>slave向master发送<code>psync2 ? -1</code>请求数据同步</p></li> <li><p>master执行<code>bgsave</code>尝试建立快照，同时建立存储增量数据的<strong>复制积压缓冲区</strong></p> <p>master发送<code>+FULLRESYNC &lt;runid&gt; &lt;offset&gt;</code>，并将RDB文件通过socket发送给slave</p></li> <li><p>slave接收RDB文件和runid以及offset信息，清空本地数据并基于RDB执行数据恢复</p> <p>slave通过<code>psync2 &lt;runid&gt; &lt;offset&gt;</code>告知master数据同步完成（<strong>全量复制</strong>）</p></li> <li><p>（若runid与offset核验通过）master将复制缓冲区中指令（aof指令<strong>逐字符地</strong>排布）以及更新后的offset（<code>+CONTINUE offset</code>）发送给slave</p> <p>（若runid与offset核验不通过）重新开始全量复制</p></li> <li><p>slave接收aof指令，保存新offset，并执行<code>bgrewriteaof</code>进行增量数据恢复</p> <p>slave告知master增量数据的运行id与offset，若master核验通过，则本次增量同步完（<strong>增量复制</strong>）</p></li></ol> <blockquote><ul><li><p>通过<code>repl-backlog-size</code>指令合理控制复制缓冲区大小，避免全量复制时间过长时复制缓冲区溢出导致的数据丢失（此时再次执行全量复制，产生死循环）</p> <p>最优复制缓冲区大小 = 2 * m-s平均重连时长 * m平均每秒写容量</p></li> <li><p>通过<code>slave-serve-stale-data no</code>使slave端只提供有限的写数据功能（不对外提供数据服务）</p></li></ul></blockquote></li> <li><p><strong>命令传播</strong></p> <ol><li>master定时向slave进行心跳检测</li> <li>slave向master发送<code>REPLCONF ACK</code>响应</li></ol> <blockquote><ul><li><p>在<code>INFO REPLICATION</code>信息中的slave0等字段中维护距离上一个心跳包的时间间隔，正常值为1（或0）</p></li> <li><p>命令传播阶段的配置项</p> <ul><li><code>min-slaves-to-write &lt;num&gt;</code></li> <li><code>min-slaves-max-lag &lt;time&gt;</code></li></ul> <p>成功响应心跳的slave个数小于num，或所有slave的延迟都大于time时，强制关闭master的写功能，停止数据同步</p> <ul><li><code>repl-timeout</code></li></ul> <p>若slave在给定时间没有响应，则master将其释放</p> <ul><li><code>repl-ping-slave-period</code></li></ul> <p>心跳检测时间间隔（一般为上一项超时时间的1/10～1/5）</p></li></ul></blockquote></li></ol> <h3 id="哨兵"><a href="#哨兵" class="header-anchor">#</a> 哨兵</h3> <ol><li>监控（同步信息）
<ol><li>连接master获取info</li> <li>进行cmd连接以进行后续的命令交换</li> <li>根据info信息连接关联的slave或sentinel</li> <li>在同时存在的多个sentinel节点间组建发布订阅网络</li></ol></li> <li>通知</li> <li>故障转移
<ol><li>发现问题</li> <li>竞选负责人</li> <li>负责人优选新master</li> <li>切换各节点主从关系</li></ol></li></ol> <h3 id="集群"><a href="#集群" class="header-anchor">#</a> 集群</h3> <ul><li>Redis集群中设置<strong>16384</strong>个哈希槽，集群中的每个节点负责一部分hash slots</li> <li>存储key时，使用该key的CRC16值对16384取模以获取目标存储槽位</li> <li>节点间槽位可互相转移（并行转移），使得集群拓展性高</li></ul> <blockquote><p><strong>集群主从模式</strong></p> <p>Redis集群主从节点之间采用异步复制共享数据，因此不能保证强一致性，可能导致数据丢失</p></blockquote> <h2 id="底层原理"><a href="#底层原理" class="header-anchor">#</a> 底层原理</h2> <h4 id="线程模型"><a href="#线程模型" class="header-anchor">#</a> 线程模型</h4> <h6 id="file-event-handler-单reactor单线程模型"><a href="#file-event-handler-单reactor单线程模型" class="header-anchor">#</a> File Event Handler（单Reactor单线程模型）</h6> <p>单线程内存操作：IO多路复用程序（采用单线程、非阻塞地）同时监听多个Socket，将读入的Socket事件放入队列中，由dispatcher依次分配对应的handler</p> <ul><li>多个Socket</li> <li>IO多路复用程序（事件分离器+IO处理器）</li> <li>事件分派器</li> <li>事件处理器
<ul><li>连接应答处理器</li> <li>命令请求处理器</li> <li>命令回复处理器</li></ul></li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
				←
				<a href="/posts/database/mysql.html" class="prev">
					MySQL基础
				</a></span> <!----></p></div> <div class="vcomment-container" data-v-07c8026b><div id="vcomments" data-v-07c8026b></div></div> </main> <!----></div><div class="global-ui"><!----><div></div></div></div>
    <script src="/assets/js/app.9bbd0500.js" defer></script><script src="/assets/js/1.7e1accfd.js" defer></script><script src="/assets/js/13.b5619b2f.js" defer></script><script src="/assets/js/18.ccf124a3.js" defer></script>
  </body>
</html>
