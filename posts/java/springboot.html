<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Spring Boot基础 | Felix Mundial的杂烩图书馆</title>
    <meta name="generator" content="VuePress 1.7.1">
    <link rel="icon" href="/icons/favicon.png">
    <meta name="description" content="github page powered by Vuepress">
    
    <link rel="preload" href="/assets/css/0.styles.0e3647e7.css" as="style"><link rel="preload" href="/assets/js/app.9bbd0500.js" as="script"><link rel="preload" href="/assets/js/1.7e1accfd.js" as="script"><link rel="preload" href="/assets/js/13.b5619b2f.js" as="script"><link rel="preload" href="/assets/js/23.36d5eb9b.js" as="script"><link rel="prefetch" href="/assets/js/10.535b18bf.js"><link rel="prefetch" href="/assets/js/11.9f4c7505.js"><link rel="prefetch" href="/assets/js/12.1040a13c.js"><link rel="prefetch" href="/assets/js/14.9065f59b.js"><link rel="prefetch" href="/assets/js/15.1af3a730.js"><link rel="prefetch" href="/assets/js/16.145ee41f.js"><link rel="prefetch" href="/assets/js/17.daef2d0a.js"><link rel="prefetch" href="/assets/js/18.ccf124a3.js"><link rel="prefetch" href="/assets/js/19.3c9e19e5.js"><link rel="prefetch" href="/assets/js/20.cbce51c7.js"><link rel="prefetch" href="/assets/js/21.aad032a5.js"><link rel="prefetch" href="/assets/js/22.d26d3f4d.js"><link rel="prefetch" href="/assets/js/24.3d224717.js"><link rel="prefetch" href="/assets/js/25.e67e5f2e.js"><link rel="prefetch" href="/assets/js/26.26226ddd.js"><link rel="prefetch" href="/assets/js/27.ef309e27.js"><link rel="prefetch" href="/assets/js/28.275159e4.js"><link rel="prefetch" href="/assets/js/29.f7f84fc3.js"><link rel="prefetch" href="/assets/js/3.92bf9476.js"><link rel="prefetch" href="/assets/js/4.7de240dc.js"><link rel="prefetch" href="/assets/js/5.422f2530.js"><link rel="prefetch" href="/assets/js/6.9952df18.js"><link rel="prefetch" href="/assets/js/7.b57f400b.js"><link rel="prefetch" href="/assets/js/8.a18e3f05.js"><link rel="prefetch" href="/assets/js/9.c6f1e43f.js">
    <link rel="stylesheet" href="/assets/css/0.styles.0e3647e7.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="azure" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name"><i class="el-icon-bicycle"></i> Felix Mundial的杂烩图书馆</span></a> <div class="links"><nav class="nav-links can-hide"><div class="nav-item"><a href="/guide/toc.html" class="nav-link" data-v-c7dec8ac><i class="el-icon-discount"></i> Archives</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">算法</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/posts/leetcode/leetcode101.html" class="nav-link" data-v-c7dec8ac><i class="iconfont icon-leetcode"></i> Leetcode</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont icon-java"></i> Java</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/posts/java/concurrency.html" class="nav-link" data-v-c7dec8ac>并发</a></li><li class="dropdown-item"><!----> <a href="/posts/java/jvm.html" class="nav-link" data-v-c7dec8ac>JVM</a></li><li class="dropdown-item"><!----> <a href="/posts/java/spring.html" class="nav-link" data-v-c7dec8ac>Spring</a></li><li class="dropdown-item"><!----> <a href="/posts/java/springmvc.html" class="nav-link" data-v-c7dec8ac>Spring MVC</a></li><li class="dropdown-item"><!----> <a href="/posts/java/springboot.html" aria-current="page" class="nav-link router-link-exact-active router-link-active" data-v-c7dec8ac>Spring Boot</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont icon-database"></i> 数据库</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/posts/database/mysql.html" class="nav-link" data-v-c7dec8ac><i class="iconfont icon-mysql"></i> MySQL</a></li><li class="dropdown-item"><!----> <a href="/posts/database/redis.html" class="nav-link" data-v-c7dec8ac><i class="iconfont icon-redis"></i> Redis</a></li></ul></div></div> <!----></nav> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/guide/toc.html" class="nav-link" data-v-c7dec8ac><i class="el-icon-discount"></i> Archives</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">算法</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/posts/leetcode/leetcode101.html" class="nav-link" data-v-c7dec8ac><i class="iconfont icon-leetcode"></i> Leetcode</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont icon-java"></i> Java</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/posts/java/concurrency.html" class="nav-link" data-v-c7dec8ac>并发</a></li><li class="dropdown-item"><!----> <a href="/posts/java/jvm.html" class="nav-link" data-v-c7dec8ac>JVM</a></li><li class="dropdown-item"><!----> <a href="/posts/java/spring.html" class="nav-link" data-v-c7dec8ac>Spring</a></li><li class="dropdown-item"><!----> <a href="/posts/java/springmvc.html" class="nav-link" data-v-c7dec8ac>Spring MVC</a></li><li class="dropdown-item"><!----> <a href="/posts/java/springboot.html" aria-current="page" class="nav-link router-link-exact-active router-link-active" data-v-c7dec8ac>Spring Boot</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont icon-database"></i> 数据库</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/posts/database/mysql.html" class="nav-link" data-v-c7dec8ac><i class="iconfont icon-mysql"></i> MySQL</a></li><li class="dropdown-item"><!----> <a href="/posts/database/redis.html" class="nav-link" data-v-c7dec8ac><i class="iconfont icon-redis"></i> Redis</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Java</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/posts/java/concurrency.html" class="sidebar-link">Java并发</a></li><li><a href="/posts/java/jvm.html" class="sidebar-link">JVM</a></li><li><a href="/posts/java/spring.html" class="sidebar-link">Spring基础</a></li><li><a href="/posts/java/springboot.html" aria-current="page" class="active sidebar-link">Spring Boot基础</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/posts/java/springboot.html#a" class="sidebar-link">A</a></li></ul></li><li><a href="/posts/java/springmvc.html" class="sidebar-link">Spring MVC基础</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="post-header" data-v-528c0c8a><h2 class="post-title" data-v-528c0c8a><a href="/posts/java/springboot.html" data-v-528c0c8a><!---->
			Spring Boot基础
		</a></h2> <div class="post-meta" data-v-528c0c8a><div class="author post-meta-item" data-v-528c0c8a><i class="el-icon-bicycle" data-v-528c0c8a></i> <span data-v-528c0c8a>FelixMundial</span></div> <div class="time post-meta-item" data-v-528c0c8a><i class="el-icon-time" data-v-528c0c8a></i> <time data-v-528c0c8a>2020-11-11</time></div> <div class="category post-meta-item" data-v-528c0c8a><i class="el-icon-collection" data-v-528c0c8a></i> <a href="/category/Spring" class="category-item" data-v-528c0c8a>
				Spring
			</a></div> <div class="tags post-meta-item" data-v-528c0c8a><i class="el-icon-price-tag" data-v-528c0c8a></i> <span class="tag-item el-tag el-tag--light" data-v-528c0c8a>
				Spring
			</span></div> <div id="/posts/java/springboot.html" data-flag-title="Spring Boot基础" class="leancloud-visitors post-meta-item" data-v-528c0c8a><i class="el-icon-reading" data-v-528c0c8a></i> <span class="leancloud-visitors-count" data-v-528c0c8a>0</span></div></div></div> <div class="theme-default-content content__default"><h1 id="springbootapplication"><a href="#springbootapplication" class="header-anchor">#</a> <code>@SpringBootApplication</code></h1> <ul><li><h4 id="springbootconfiguration"><a href="#springbootconfiguration" class="header-anchor">#</a> <code>@SpringBootConfiguration</code></h4> <ul><li><code>@Configuration</code></li></ul></li> <li><h4 id="enableautoconfiguration"><a href="#enableautoconfiguration" class="header-anchor">#</a> <code>@EnableAutoConfiguration</code></h4></li> <li><h4 id="componentscan-excludefilters-filter-type-filtertype-custom-classes-typeexcludefilter-class-filter-type-filtertype-custom-classes-autoconfigurationexcludefilter-class"><a href="#componentscan-excludefilters-filter-type-filtertype-custom-classes-typeexcludefilter-class-filter-type-filtertype-custom-classes-autoconfigurationexcludefilter-class" class="header-anchor">#</a> <code>@ComponentScan(excludeFilters = { @Filter(type = FilterType.CUSTOM, classes = TypeExcludeFilter.class), @Filter(type = FilterType.CUSTOM, classes = AutoConfigurationExcludeFilter.class) })</code></h4></li></ul> <h1 id="自动配置"><a href="#自动配置" class="header-anchor">#</a> 自动配置</h1> <h3 id="依赖管理与版本仲裁"><a href="#依赖管理与版本仲裁" class="header-anchor">#</a> 依赖管理与版本仲裁</h3> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parent</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-parent<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.3.8.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>parent</span><span class="token punctuation">&gt;</span></span>
  
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parent</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.3.8.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>parent</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>如需更换依赖版本号，在当前项目中通过<code>&lt;properties&gt;&lt;/properties&gt;</code>标签指定即可（maven就近优先原则）</p> <h3 id="自定义组件扫描与场景启动器配置"><a href="#自定义组件扫描与场景启动器配置" class="header-anchor">#</a> 自定义组件扫描与场景启动器配置</h3> <h4 id="enableautoconfiguration-2"><a href="#enableautoconfiguration-2" class="header-anchor">#</a> <code>@EnableAutoConfiguration</code></h4> <ul><li><h5 id="autoconfigurationpackage"><a href="#autoconfigurationpackage" class="header-anchor">#</a> <code>@AutoConfigurationPackage</code></h5> <ul><li><p><code>@Import(AutoConfigurationPackages.Registrar.class)</code></p> <p>默认将主程序类<strong>所在包</strong>及其子包内所有组件扫描进Spring容器；如需扩大包扫描层级范围，需通过<code>@SpringBootApplication(scanBasePackages=&quot;com.xxx&quot;)</code>进行指定</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// AutoConfigurationPackages.class</span>

<span class="token comment">/**
* {@link ImportBeanDefinitionRegistrar} to store the base package from the importing configuration.
*/</span>
<span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Registrar</span> <span class="token keyword">implements</span> <span class="token class-name">ImportBeanDefinitionRegistrar</span><span class="token punctuation">,</span> <span class="token class-name">DeterminableImports</span> <span class="token punctuation">{</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">registerBeanDefinitions</span><span class="token punctuation">(</span><span class="token class-name">AnnotationMetadata</span> metadata<span class="token punctuation">,</span> <span class="token class-name">BeanDefinitionRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">register</span><span class="token punctuation">(</span>registry<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">PackageImports</span><span class="token punctuation">(</span>metadata<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPackageNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">determineImports</span><span class="token punctuation">(</span><span class="token class-name">AnnotationMetadata</span> metadata<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">singleton</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PackageImports</span><span class="token punctuation">(</span>metadata<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div></li></ul></li> <li><h5 id="import-enableautoconfigurationimportselector-class"><a href="#import-enableautoconfigurationimportselector-class" class="header-anchor">#</a> <code>@Import(EnableAutoConfigurationImportSelector.class)</code></h5> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AutoConfigurationImportSelector</span> <span class="token keyword">implements</span> <span class="token class-name">DeferredImportSelector</span> <span class="token punctuation">{</span>
 	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">selectImports</span><span class="token punctuation">(</span><span class="token class-name">AnnotationMetadata</span> metadata<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  	<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">Configurations</span> <span class="token operator">=</span> <span class="token function">getCandidateConfigurations</span><span class="token punctuation">(</span>metadata<span class="token punctuation">,</span> attributes<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取所有可能加入容器的EnableAutoConfiguration</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// ...</span>

	<span class="token keyword">protected</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">getCandidateConfigurations</span><span class="token punctuation">(</span><span class="token class-name">AnnotationMetadata</span> metadata<span class="token punctuation">,</span> <span class="token class-name">AnnotationAttributes</span> attributes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isEnabled</span><span class="token punctuation">(</span>annotationMetadata<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> NO_IMPORTS<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token class-name">AutoConfigurationMetadata</span> autoConfigurationMetadata <span class="token operator">=</span> <span class="token class-name">AutoConfigurationMetadataLoader</span><span class="token punctuation">.</span><span class="token function">loadMetadata</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanClassLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">AnnotationAttributes</span> attributes <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getAttributes</span><span class="token punctuation">(</span>annotationMetadata<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">Configurations</span> <span class="token operator">=</span> <span class="token class-name">SpringFactoriesLoader</span><span class="token punctuation">.</span><span class="token function">loadFactoryNames</span><span class="token punctuation">(</span><span class="token function">getSpringFactoriesLoaderFactoryClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">/*此处的类加载器为AppClassLoader*/</span><span class="token punctuation">,</span> <span class="token function">gerBeanClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            configurations <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">removeDuplicates</span><span class="token punctuation">(</span>configurations<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> exclusions <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getExclusions</span><span class="token punctuation">(</span>annotationMetadata<span class="token punctuation">,</span> attributes<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">checkExcludedClasses</span><span class="token punctuation">(</span>configurations<span class="token punctuation">,</span> exclusions<span class="token punctuation">)</span><span class="token punctuation">;</span>
            configurations<span class="token punctuation">.</span><span class="token function">removeAll</span><span class="token punctuation">(</span>exclusions<span class="token punctuation">)</span><span class="token punctuation">;</span>
            configurations <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>configurations<span class="token punctuation">,</span> autoConfigurationMetadata<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fireAutoConfigurationImportEvents</span><span class="token punctuation">(</span>configurations<span class="token punctuation">,</span> exclusions<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">toStringArray</span><span class="token punctuation">(</span>configurations<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
	<span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre></div><h4 id="自动配置核心流程"><a href="#自动配置核心流程" class="header-anchor">#</a> 自动配置核心流程</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// SpringFactoriesLoader.class</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> list<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">loadFactoryNames</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> factoryClass<span class="token punctuation">,</span> <span class="token class-name">ClassLoader</span> classLoader<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token class-name">Enumeration</span> ex <span class="token operator">=</span> classLoader <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> classLoader<span class="token punctuation">.</span><span class="token function">getResources</span><span class="token punctuation">(</span><span class="token string">&quot;META-INF/spring.factories&quot;</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token class-name">ClassLoader</span><span class="token punctuation">.</span><span class="token function">getSystemResources</span><span class="token punctuation">(</span><span class="token string">&quot;META-INF/spring.factories&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 从类路径（spring-boot-autoconfigure-xxx-RELEASE）下META-INFO/spring.factories文件中获取org.springframework.boot.autoconfigure.EnableAutoConfiguration所对应的组件（配置类）key值，最终通过反射对配置类中的组件进行实例化</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <h1 id="启动流程"><a href="#启动流程" class="header-anchor">#</a> 启动流程</h1> <h6 id="springboot-1-x"><a href="#springboot-1-x" class="header-anchor">#</a> SpringBoot 1.x</h6> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ConfigurableApplicationContext</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> sources<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SpringApplication</span><span class="token punctuation">(</span>sources<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// SpringApplication.class</span>

<span class="token keyword">public</span> <span class="token class-name">SpringApplication</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> sources<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">initialize</span><span class="token punctuation">(</span>sources<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// ...</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">initialize</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> sources<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// SpringApplication.getSpringFactoriesInstances(...)：</span>
  <span class="token comment">// 从类路径（spring-boot-autoconfigure-xxx-RELEASE）下META-INFO/spring.factories文件中获取所有的ApplicationContextInitializer和所有的ApplicationListener；两者都不需要手动加入容器，而只需在classpath:/META-INF/spring.factories中进行配置（ApplicationRunner需手动加入容器）</span>
  <span class="token comment">// 定位main()方法</span>
<span class="token punctuation">}</span>
</code></pre></div><h1 id="运行流程"><a href="#运行流程" class="header-anchor">#</a> 运行流程</h1> <h6 id="springboot-1-x-2"><a href="#springboot-1-x-2" class="header-anchor">#</a> SpringBoot 1.x</h6> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// SpringApplication.class</span>

<span class="token keyword">public</span> <span class="token class-name">ConfigurableApplicationContext</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token class-name">Stopwatch</span> stopwatch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Stopwatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  stopwatch<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">ConfigurableApplicationContext</span> context <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
  <span class="token class-name">SpringApplicationRunListeners</span> listeners <span class="token operator">=</span> <span class="token function">getRunListeners</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
  listeners<span class="token punctuation">.</span><span class="token function">starting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 回调所有SpringApplicationRunListener监听器的starting()方法</span>
  
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token class-name">ApplicationArguments</span> applicationArguments <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultApplicationArguments</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 封装命令行参数</span>
    <span class="token class-name">ConfigurableEnvironment</span> environment <span class="token operator">=</span> <span class="token function">prepareEnvironment</span><span class="token punctuation">(</span>listeners<span class="token punctuation">,</span> applicationArguments<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1. getOrCreateEnvironment() 2. configureEnvironment(environment, args) 3. listeners.environmentPrepared(environment)</span>
    <span class="token class-name">Banner</span> banner <span class="token operator">=</span> <span class="token function">printBanner</span><span class="token punctuation">(</span>environment<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    context <span class="token operator">=</span> <span class="token function">createApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// ...</span>
  <span class="token function">prepareContext</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> environment<span class="token punctuation">,</span> listeners<span class="token punctuation">,</span> applicationArguments<span class="token punctuation">,</span> printedBanner<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1. context.setEnvironment(environment) 2. postProcessApplicationContext(context) 向容器注册附加组件 3. applyInitializers(context) 依次执行所有ApplicationContextInitializer的initialize(ConfigurableApplicationContext)方法 3. listeners.contextPrepared(context) 4. context.getBeanFactory().registerSingleton(&quot;springApplicationArguments&quot;, applicationArguments) 5. load(context, sources.toArray(new Object[sources.size()])) 向ConfigurableApplicationContext加载sources（主类信息） 6. listeners.contextLoaded(context);</span>
  
  <span class="token function">refreshContext</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 自动扫描、创建、加载容器内所有组件（包括内嵌Servlet容器）</span>
  
  <span class="token function">afterRefresh</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> applicationArguments<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取容器中所有的ApplicationRunner及CommandLineRunner，并传入args进行回调</span>
  listeners<span class="token punctuation">.</span><span class="token function">finished</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  stopwatch<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
  <span class="token keyword">return</span> context<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h1 id="自定义starters"><a href="#自定义starters" class="header-anchor">#</a> 自定义Starters</h1> <blockquote><p><code>xxx-starter</code>只用于pom文件中所需依赖的导入，而前者引入的<code>xxx-starter-autoconfigurer</code>真正负责依赖注入过程</p></blockquote> <h5 id="xxx-starter-autoconfigurer"><a href="#xxx-starter-autoconfigurer" class="header-anchor">#</a> <code>xxx-starter-autoconfigurer</code></h5> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AbcService</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> <span class="token class-name">AbcProperties</span> properties<span class="token punctuation">;</span>
  
  <span class="token keyword">public</span> <span class="token class-name">AbcProperties</span> <span class="token function">getAbcProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   	<span class="token keyword">return</span> properties<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
  
  <span class="token comment">// IoC</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setAbcProperties</span><span class="token punctuation">(</span><span class="token class-name">AbcProperties</span> properties<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>properties <span class="token operator">=</span> properties<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token keyword">public</span> <span class="token class-name">AbcService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
  
<span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span>abc <span class="token operator">=</span> <span class="token string">&quot;abc&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AbcProperties</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> <span class="token class-name">String</span> abc<span class="token punctuation">;</span>
  
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@ConditionalOnXXX</span>
<span class="token annotation punctuation">@EnableConfigurationProperties</span><span class="token punctuation">(</span><span class="token class-name">AbcProperties</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AbcAutoConfiguration</span> <span class="token punctuation">{</span>
<span class="token annotation punctuation">@Autowired</span>
  <span class="token keyword">private</span> <span class="token class-name">AbcProperties</span> properties<span class="token punctuation">;</span>

  <span class="token annotation punctuation">@Bean</span>
  <span class="token keyword">public</span> <span class="token class-name">AbcService</span> <span class="token function">abcService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">AbcService</span> abcService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AbcService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    abcService<span class="token punctuation">.</span><span class="token function">setAbcProperties</span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> abcService<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="classpath-meta-inf-spring-factories"><a href="#classpath-meta-inf-spring-factories" class="header-anchor">#</a> classpath:META-INF/spring.factories</h5> <div class="language-factories extra-class"><pre class="language-text"><code>org.springframework.boot.autoconfigure.EnableAutoConfiguration=\
xxx.AbcAutoConfiguration
</code></pre></div><h3 id="自定义配置"><a href="#自定义配置" class="header-anchor">#</a> 自定义配置</h3> <h5 id="自定义配置类并与配置文件绑定"><a href="#自定义配置类并与配置文件绑定" class="header-anchor">#</a> 自定义配置类并与配置文件绑定</h5> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">&quot;xxx.yyy&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">XXXConfiguration</span> <span class="token punctuation">{</span>
	<span class="token comment">// 需在配置文件中使用的属性</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="使用自定义配置文件所配置属性"><a href="#使用自定义配置文件所配置属性" class="header-anchor">#</a> 使用自定义配置文件所配置属性</h5> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// @EnableConfigurationProperties(XXXConfiguration.class) // 因XXXConfiguration已加入容器，故无需再次声明</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AAAConfiguration</span> <span class="token punctuation">{</span>
  <span class="token annotation punctuation">@Bean</span>
  <span class="token keyword">public</span> <span class="token class-name">SomeClass</span> <span class="token function">someClass</span><span class="token punctuation">(</span><span class="token class-name">XXXConfiguration</span> config<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 使用config属性（即配置文件中所配置的值）进行进一步属性注入</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h1 id="web"><a href="#web" class="header-anchor">#</a> Web</h1> <h3 id="webmvcautoconfiguration"><a href="#webmvcautoconfiguration" class="header-anchor">#</a> <code>WebMvcAutoConfiguration</code></h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span><span class="token punctuation">(</span>proxyBeanMethods <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token comment">// @Configuration // 1.x</span>
<span class="token annotation punctuation">@ConditionalOnWebApplication</span><span class="token punctuation">(</span>type <span class="token operator">=</span> <span class="token class-name">Type</span><span class="token punctuation">.</span>SERVLET<span class="token punctuation">)</span>
<span class="token comment">// @ConditionalOnWebApplication // 1.x</span>
<span class="token annotation punctuation">@ConditionalOnClass</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token class-name">Servlet</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">DispatcherServlet</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">WebMvcConfigurer</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ConditionalOnMissingBean</span><span class="token punctuation">(</span><span class="token class-name">WebMvcConfigurationSupport</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@AutoConfigureOrder</span><span class="token punctuation">(</span><span class="token class-name">Ordered</span><span class="token punctuation">.</span>HIGHEST_PRECEDENCE <span class="token operator">+</span> <span class="token number">10</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@AutoConfigureAfter</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token class-name">DispatcherServletAutoConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">TaskExecutionAutoConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
		<span class="token class-name">ValidationAutoConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// @AutoConfigureAfter({DispatcherServletAutoConfiguration.class, ValidationAutoConfiguration.class}) // 1.x</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebMvcAutoConfiguration</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="springboot对spring-mvc的自动配置"><a href="#springboot对spring-mvc的自动配置" class="header-anchor">#</a> <code>SpringBoot</code>对<code>Spring MVC</code>的自动配置</h3> <ul><li><h5 id="自动配置了contentnegotiatingviewresolver以及beannameviewresolver"><a href="#自动配置了contentnegotiatingviewresolver以及beannameviewresolver" class="header-anchor">#</a> 自动配置了<code>ContentNegotiatingViewResolver</code>以及<code>BeanNameViewResolver</code></h5></li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// ContentNegotiatingViewResolver.class</span>
 
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">initServletContext</span><span class="token punctuation">(</span><span class="token class-name">ServletContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ViewResolver</span><span class="token punctuation">&gt;</span></span> matchingBeans <span class="token operator">=</span> <span class="token class-name">BeanFactoryUtils</span><span class="token punctuation">.</span><span class="token function">beansOfTypeIncludingAncesters</span><span class="token punctuation">(</span><span class="token function">getApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">ViewResolver</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取容器中所有的ViewResolver（并组合）</span>
<span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li><h5 id="静态资源相关配置"><a href="#静态资源相关配置" class="header-anchor">#</a> 静态资源相关配置</h5> <h6 id="前后端耦合架构下静态资源映射规则-springboot-1-x"><a href="#前后端耦合架构下静态资源映射规则-springboot-1-x" class="header-anchor">#</a> <s>前后端耦合架构下静态资源映射规则（SpringBoot 1.x）</s></h6> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// ResourceProperties.java</span>
<span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">&quot;spring.resources&quot;</span><span class="token punctuation">,</span> ignoreUnknownFields <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ResourceProperties</span> <span class="token keyword">implements</span> <span class="token class-name">ResourceLoaderAware</span> <span class="token punctuation">{</span>
<span class="token comment">// 设置与静态资源相关的参数，以便在配置文件中进行配置</span>
<span class="token punctuation">}</span>
</code></pre></div><h6 id="静态资源默认映射路径"><a href="#静态资源默认映射路径" class="header-anchor">#</a> <s>静态资源默认映射路径</s></h6> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// WebMvcAutoConfiguration.java</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addResourceHandlers</span><span class="token punctuation">(</span><span class="token class-name">ResourceHandlerRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  registry<span class="token punctuation">.</span><span class="token function">addResourceHandler</span><span class="token punctuation">(</span><span class="token string">&quot;/webjars/**&quot;</span><span class="token punctuation">)</span>
      			<span class="token punctuation">.</span><span class="token function">addResourceLocation</span><span class="token punctuation">(</span><span class="token string">&quot;classpath:/META-INF/resources/webjars/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 配置webjars静态资源映射</span>
  <span class="token comment">// ...</span>
  registry<span class="token punctuation">.</span><span class="token function">addResourceHandler</span><span class="token punctuation">(</span>staticPathPattern<span class="token punctuation">)</span> <span class="token comment">// 默认为&quot;/**&quot;</span>
      			<span class="token punctuation">.</span><span class="token function">addResourceLocation</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>resourceProperties<span class="token punctuation">.</span>getStaticLocations<span class="token punctuation">)</span> <span class="token comment">// （在配置文件中指定静态资源路径后）在此配置路径映射：spring.resources.static.locations：&quot;classpath:/META-INF/resources/&quot;, &quot;classpath:/resources/&quot;, &quot;classpath:/static/&quot;, &quot;classpath:/public/&quot;, &quot;/&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><h6 id="欢迎页面默认映射路径"><a href="#欢迎页面默认映射路径" class="header-anchor">#</a> <s>欢迎页面默认映射路径</s></h6> <ul><li><p><s>遍历所有静态资源路径，映射第一个index.html</s></p></li> <li><h5 id="hiddenhttpmethodfilter"><a href="#hiddenhttpmethodfilter" class="header-anchor">#</a> <code>HiddenHttpMethodFilter</code></h5> <p>支持RESTful请求</p></li> <li><h5 id="formatter及converter"><a href="#formatter及converter" class="header-anchor">#</a> <code>Formatter</code>及<code>Converter</code></h5> <blockquote><p><code>@ConditionalOnProperty(prefix=&quot;spring.mvc&quot;, name=&quot;xxx&quot;)</code></p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// WebMvcAutoConfiguration.java</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addFormatters</span><span class="token punctuation">(</span><span class="token class-name">FormatterRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token class-name">ApplicationConversionService</span><span class="token punctuation">.</span><span class="token function">addBeans</span><span class="token punctuation">(</span>registry<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 容器中各类GenericConverter/Converter/Formatter/Printer/Parser在ApplicationConversionService中自动配置</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li><p><s><code>DateFormatter</code></s></p> <blockquote><p>SpringBoot 2.x已废弃，==日期格式化工具配置可参考<code>FormattingConversionService</code>==</p></blockquote> <ul><li><p><code>HttpMessageConverters</code></p> <p>处理响应体字符编码；如需自定义消息转换器，可手动在容器中加入<code>HttpMessageConverters</code> （==SpringBoot 2.x中如何手动配置==）</p> <blockquote><p>SpringBoot 2.x中，不再直接配置<code>messageConverters</code>，改为配置<code>messageConvertersProvider</code></p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// WebMvcAutoConfiguration.java</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configureMessageConverters</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HttpMessageConverter</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> converters<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">this</span><span class="token punctuation">.</span>messageConvertersProvider<span class="token punctuation">.</span><span class="token function">ifAvailable</span><span class="token punctuation">(</span><span class="token punctuation">(</span>customConverters<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> converters<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>customConverters<span class="token punctuation">.</span><span class="token function">getConverters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul></li></ul></li></ul></li> <li><h5 id="messagecodesresolver"><a href="#messagecodesresolver" class="header-anchor">#</a> <code>MessageCodesResolver</code></h5> <p>定义HTTP状态码生成规则</p></li> <li><h5 id="configurablewebbindinginitializer"><a href="#configurablewebbindinginitializer" class="header-anchor">#</a> <code>ConfigurableWebBindingInitializer</code></h5> <p>将（非<code>@RequestBody</code>）请求参数封装为POJO</p></li></ul> <h3 id="自定义spring-mvc配置类"><a href="#自定义spring-mvc配置类" class="header-anchor">#</a> 自定义<code>Spring MVC</code>配置类</h3> <blockquote><p>SpringBoot 2.x新增</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 配置视图映射</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomMvcConfiguration</span> <span class="token keyword">extends</span> <span class="token class-name">WebMvcConfigurationSupport</span> <span class="token punctuation">{</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">addViewControllers</span><span class="token punctuation">(</span><span class="token class-name">ViewControllerRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    registry<span class="token punctuation">.</span><span class="token function">addViewController</span><span class="token punctuation">(</span><span class="token string">&quot;/xxx&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addViewName</span><span class="token punctuation">(</span><span class="token string">&quot;yyy&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
    
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">addResourceHandlers</span><span class="token punctuation">(</span><span class="token class-name">ViewControllerRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 添加自定义静态资源映射</span>
  <span class="token punctuation">}</span>
    
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">addInterceptors</span><span class="token punctuation">(</span><span class="token class-name">ViewControllerRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 添加自定义拦截器（需要排除静态资源）</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="enablewebmvcconfiguration-内部类webmvcautoconfigurationadapter的-import依赖类"><a href="#enablewebmvcconfiguration-内部类webmvcautoconfigurationadapter的-import依赖类" class="header-anchor">#</a> <code>EnableWebMvcConfiguration</code>（内部类<code>WebMvcAutoConfigurationAdapter</code>的<code>@Import</code>依赖类）</h5> <div class="language- extra-class"><pre class="language-text"><code>// DelegatingWebMvcConfiguration.class （EnableWebMvcConfiguration父类，WebMvcConfigurationSupport子类）

private final WebMvcConfigurerComposite configurers = new WebMvcConfigurerComposite();

@Autowired(required = false)
public void setConfigurers(List&lt;WebMvcConfigurer&gt; configurers) {
if (!CollectionUtils.isEmpty(configurers)) {
  this.configurers.addWebMvcConfigurers(configurers); // 调用容器中所有WebMvcConfigurer实现类的addViewControllers(ViewControllerRegistry)方法
}
}
</code></pre></div><blockquote><p>若在配置类上标注<code>@EnableWebMvc</code>，则将全面接管<code>Spring MVC</code>的自动配置</p></blockquote> <h4 id="errormvcautoconfiguration"><a href="#errormvcautoconfiguration" class="header-anchor">#</a> <code>ErrorMvcAutoConfiguration</code></h4> <ul><li><p><code>DefaultErrorAttributes</code></p> <p>为<code>ModelAndView</code>对象（或响应体）传递异常信息：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">getErrorAttributes</span><span class="token punctuation">(</span><span class="token class-name">RequestAttributes</span> attr<span class="token punctuation">,</span> <span class="token keyword">boolean</span> includesStackTrace<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> errorAttributes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  errorAttributes<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;timestamp&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">addStatus</span><span class="token punctuation">(</span>errorAttributes<span class="token punctuation">,</span> requestAttributes<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">addErrorDetails</span><span class="token punctuation">(</span>errorAttributes<span class="token punctuation">,</span> requestAttributes<span class="token punctuation">,</span> includesStackTrace<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">addPath</span><span class="token punctuation">(</span>errorAttributes<span class="token punctuation">,</span> requestAttributes<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> errorAttributes<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>SpringBoot 2.x中该方法参数为<code>WebRequest</code>的子类<code>WebRequest</code></p></blockquote></li> <li><p><code>ErrorPageCustomizer</code></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">void</span> <span class="token function">registerErrorPages</span><span class="token punctuation">(</span><span class="token class-name">ErrorPageRegistry</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 给容器添加错误页面请求映射（默认为/error）</span>
</code></pre></div></li> <li><p><code>BasicErrorController</code></p></li></ul> <p>处理<code>ErrorPageCustomizer</code>注册的错误页面请求</p> <ul><li><p><code>DefaultErrorViewResolver</code></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">ModelAndView</span> <span class="token function">resolveErrorView</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">,</span> <span class="token class-name">HttpStatus</span><span class="token punctuation">,</span> <span class="token class-name">Model</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 解析HTTP状态码和model数据，返回ModelAndView对象</span>
</code></pre></div><ul><li><p>给浏览器响应页面：</p> <p>调用<code>DefaultErrorViewResolver</code>返回<code>ModelAndView</code>对象或默认的<code>DefaultErrorView</code>（<code>SpelView</code>默认错误页面，对应<code>/error</code>视图）</p></li> <li><p>给其他客户端响应JSON数据：</p></li></ul></li></ul> <h5 id="定制错误页面"><a href="#定制错误页面" class="header-anchor">#</a> 定制错误页面</h5> <ul><li>项目依赖模板引擎：<code>classpath:/templates/error/4xx.html</code></li> <li>项目不依赖模板引擎：<code>classpath:/static/error/4xx.html</code></li></ul> <h5 id="定制错误响应"><a href="#定制错误响应" class="header-anchor">#</a> 定制错误响应</h5> <ul><li>（错误信息完全由前端框架处理）自定义<code>@ExceptionHandler</code>方法，返回JSON数据</li> <li>（错误信息由SpringBoot自行处理）自定义<code>@ExceptionHandler</code>方法，转发至<code>/error</code>请求（或自定义错误页面请求）</li> <li>（如需给浏览器返回后端渲染的错误页面）在<code>request</code>域中自定义<code>&quot;javax.servlet.error.status_code&quot;</code>属性，赋值为错误状态码，即可通过<code>DefaultErrorViewResolver.resolveErrorView(...)</code>方法定位自定义错误页面
<ul><li>（扩展JSON属性）重写<code>DefaultErrorAttributes.getErrorAttributes(RequestAttributes)</code>方法</li></ul></li></ul> <h3 id="嵌入式servlet容器"><a href="#嵌入式servlet容器" class="header-anchor">#</a> 嵌入式<code>Servlet</code>容器</h3> <ul><li><p>配置文件（如配置文件中的<code>server.xxx</code>属性）</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">&quot;server&quot;</span><span class="token punctuation">,</span> ignoreUnknownFields <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ServerProperties</span> <span class="token keyword">implements</span> <span class="token class-name">EmbeddedServletContainerCustomizer</span><span class="token punctuation">,</span> <span class="token class-name">EnvironmentAware</span><span class="token punctuation">,</span> <span class="token class-name">Ordered</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token comment">// SpringBoot 2.x中对应WebServerProperties.class</span>
</code></pre></div></li> <li><p>配置类（<code>EmbeddedServletContainerCustomizer</code>，或SpringBoot 2.x中的<code>WebServerFactoryCustomizer&lt;ConfigurableWebServerFactory&gt;</code>）</p></li></ul> <h4 id="嵌入式servlet容器自动配置原理"><a href="#嵌入式servlet容器自动配置原理" class="header-anchor">#</a> 嵌入式<code>Servlet</code>容器自动配置原理</h4> <h6 id="springboot-1-x-3"><a href="#springboot-1-x-3" class="header-anchor">#</a> SpringBoot 1.x</h6> <h5 id="embeddedservletcontainerautoconfiguration"><a href="#embeddedservletcontainerautoconfiguration" class="header-anchor">#</a> <code>EmbeddedServletContainerAutoConfiguration</code></h5> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//@...</span>
<span class="token annotation punctuation">@Import</span><span class="token punctuation">(</span><span class="token class-name">BeanPostProcessorRegistrar</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token comment">// 向容器中导入EmbeddedServletContainerCustomizerBeanPostProcessor，遍历执行容器中所有EmbeddedServletContainerCustomizer.customize(...)方法</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EmbeddedServletContainerAutoConfiguration</span> <span class="token punctuation">{</span>
<span class="token comment">// 根据容器中Servlet容器工厂类型，初始化特定的XXXEmbeddedServletContainerFactory工厂</span>
<span class="token punctuation">}</span>
</code></pre></div><p>配置内嵌Servlet容器的基本环境，并最终启动该容器</p> <blockquote><p>实现<code>EmbeddedServletContainerFactory</code>接口，在<code>EmbeddedServletContainer getEmbeddedServletContainer(ServletContextInitializer...)</code>方法中对内嵌<code>Servlet</code>容器的基本环境进行配置</p></blockquote> <h6 id="springboot-2-x"><a href="#springboot-2-x" class="header-anchor">#</a> SpringBoot 2.x</h6> <h5 id="servletwebserverfactoryautoconfiguration"><a href="#servletwebserverfactoryautoconfiguration" class="header-anchor">#</a> <code>ServletWebServerFactoryAutoConfiguration</code></h5> <blockquote><p>或实现<code>ServletWebServerFactory</code>接口，重写<code>WebServer getWebServer(ServletContextInitializer...)</code>方法</p></blockquote> <h4 id="嵌入式servlet容器启动原理"><a href="#嵌入式servlet容器启动原理" class="header-anchor">#</a> 嵌入式<code>Servlet</code>容器启动原理</h4> <ol><li><p><code>SpringApplication.class</code></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ConfigurableApplicationContext</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> sources<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SpringApplication</span><span class="token punctuation">(</span>sources<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// ...</span>

<span class="token keyword">public</span> <span class="token class-name">ConfigurableApplicationContext</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token class-name">ConfigurableApplicationContext</span> context <span class="token operator">=</span> <span class="token function">createApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
  <span class="token function">refreshContext</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token comment">// ...</span>

<span class="token keyword">protected</span> <span class="token class-name">ConfigurableApplicationContext</span> <span class="token function">createApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 如果需要创建Web容器，则初始化AnnotationConfigEmbeddedWebApplicationContext，否则初始化AnnotationConfigApplicationContext</span>
<span class="token punctuation">}</span>

<span class="token comment">// ...</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">refreshContext</span><span class="token punctuation">(</span><span class="token class-name">ConfigurableApplicationContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">refresh</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 调用AbstractApplicationContext.refresh()方法，在其中调用子容器的onRefresh()方法</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p><code>EmbeddedWebApplicationContext.class</code></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onRefresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onRefresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token function">createEmbeddedServletContainer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token comment">// ...</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">createEmbeddedServletContainer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token class-name">EmbeddedServletContainerFactory</span> containerFactory <span class="token operator">=</span> <span class="token function">getEmbeddedServletContainerFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 通过内嵌Servlet容器工厂，并借助EmbeddedServletContainerCustomizerBeanPostProcessor后置处理器遍历容器中所有EmbeddedServletContainerCustomizer容器定制器对创建的Servlet容器进行环境配置</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>embeddedServletContainer containerFactory<span class="token punctuation">.</span><span class="token function">getEmbeddedServletContainer</span><span class="token punctuation">(</span><span class="token function">getSelfInitializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取Servlet容器</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ol> <h1 id="日志"><a href="#日志" class="header-anchor">#</a> 日志</h1> <p>默认采用<code>Logback</code>作为日志实现</p> <p><code>org.springframework.boot:spring-boot-starter-logging</code>：</p> <ul><li><code>ch.qos.logback:logback-classic</code> <ul><li><code>org.slf4j:slf4j-api</code></li> <li><code>ch.qos.logback:logback-core</code></li></ul></li> <li><code>org.apache.logging.log4j:log4j-to-slf4j</code> // 将<code>Log4j</code>替换为<code>Slf4j</code> <ul><li><code>org.slf4j:slf4j-api</code></li> <li><code>org.apache.logging.log4j:log4j-api</code></li></ul></li> <li><code>org.slf4j:jul-to-slf4j</code> // 将<code>JUL</code>替换为<code>Slf4j</code> <ul><li><code>org.slf4j:slf4j-api</code></li> <li><code>SLF4JBrindgeHandler</code>已存在</li></ul></li></ul> <blockquote><p><code>org.springframework:spring-core</code>：</p> <ul><li><code>spring-jcl</code> （内置<code>jcl-slf4j</code>桥接？）</li></ul></blockquote> <p>可在类路径下自定义日志配置文件（如logback-spring.xml），并实现基于不同开发环境的动态日志格式</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>springProfile</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>staging<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
	<span class="token comment">&lt;!-- &lt;pattern&gt;&lt;/pattern&gt; --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>springProfile</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h1 id="数据源"><a href="#数据源" class="header-anchor">#</a> 数据源</h1> <h4 id="datasourceautoconfiguration"><a href="#datasourceautoconfiguration" class="header-anchor">#</a> <code>DataSourceAutoConfiguration</code></h4> <ul><li><p><code>DataSourceConfiguration</code></p> <p>自定义数据源类型</p></li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@ConditionalOnMissingBean</span><span class="token punctuation">(</span><span class="token class-name">DataSource</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ConditionalOnProperty</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;spring.datasource.type&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Generic</span> <span class="token punctuation">{</span>
  
  <span class="token annotation punctuation">@Bean</span>
  <span class="token keyword">public</span> <span class="token class-name">DataSource</span> <span class="token function">dataSource</span><span class="token punctuation">(</span><span class="token class-name">DataSourceProperties</span> properties<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> properties<span class="token punctuation">.</span><span class="token function">initializeDataSourceBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 利用反射创建spring.datasource.type对应类型的数据源，并绑定相关属性</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li><p><code>DataSourceInitializer</code></p> <p>监听容器启动，运行特定的SQL脚本</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token comment"># SpringBoot 2.x </span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
	<span class="token key atrule">datasource</span><span class="token punctuation">:</span>
		<span class="token comment"># ...</span>
		<span class="token key atrule">initialization-mode</span><span class="token punctuation">:</span> always
		<span class="token key atrule">schema</span><span class="token punctuation">:</span>
 			<span class="token punctuation">-</span> xxx.sql
</code></pre></div></li></ul> <h1 id="缓存"><a href="#缓存" class="header-anchor">#</a> 缓存</h1> <h4 id="cacheable-声明式缓存-默认缓存key为cachenames-key"><a href="#cacheable-声明式缓存-默认缓存key为cachenames-key" class="header-anchor">#</a> <code>Cacheable</code>（声明式缓存，默认缓存key为<code>cacheNames</code> + <code>key</code>）</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Cacheable</span><span class="token punctuation">(</span>cacheNames <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;abc&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> key <span class="token operator">=</span> <span class="token string">&quot;#root.methodName + '[' + #id + ']'&quot;</span><span class="token punctuation">,</span> condition <span class="token operator">=</span> <span class="token string">&quot;#a0 &gt; 0&quot;</span><span class="token punctuation">,</span> unless <span class="token operator">=</span> <span class="token string">&quot;#result == null&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">SomePOJO</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li><code>value</code>/<code>cacheNames</code>属性指定缓存组件名（可将公共组件名单独以<code>@CacheConfig</code>注解方式配置在类上）</li> <li><code>key</code>属性指定缓存key（默认为方法参数值）</li> <li>属性值可使用SpEl表达式（如<code>#root.method.name</code>/<code>#root.targetClass</code>/<code>#root.args[0]</code>），若只使用字符串需加上单引号进行区分</li> <li><code>sync</code>属性指定缓存操作逻辑是否使用<code>synchronized</code>同步代码块</li></ul> <h5 id="cacheautoconfiguration"><a href="#cacheautoconfiguration" class="header-anchor">#</a> <code>CacheAutoConfiguration</code></h5> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// ...</span>
<span class="token annotation punctuation">@Import</span><span class="token punctuation">(</span><span class="token class-name">CacheConfigurationImportSelector</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token comment">// 获取所有可能加入容器的缓存配置类</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CacheAutoConfiguration</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre></div><h6 id="simplecacheconfiguration"><a href="#simplecacheconfiguration" class="header-anchor">#</a> <code>SimpleCacheConfiguration</code></h6> <blockquote><p>容器启动时默认的缓存配置类为<code>SimpleCacheConfiguration</code>，采用<code>ConcurrentMapCacheManager</code>作为缓存管理器，后者使用<code>ConcurrentHashMap</code>进行存储</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Cache</span> <span class="token function">getCache</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token class-name">Cache</span> cache <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cacheMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>cache <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>dynamic<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>cacheMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      cache <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cacheMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 二次获取（？）</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>cache <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        cache <span class="token operator">=</span> <span class="token function">createCocurrentMapCache</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>cacheMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> cache<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> cache<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="cacheable方法执行缓存存取流程"><a href="#cacheable方法执行缓存存取流程" class="header-anchor">#</a> <code>@Cacheable</code>方法执行缓存存取流程</h5> <ol><li><p><code>CacheManager.getCache(cacheId)</code></p></li> <li><p><code>CacheAspectSupport.generateKey(result)</code>借助<code>SimpleKeyGenerator.generate(...)</code>生成缓存key</p> <blockquote><p>可在配置类中注入<code>KeyGenerator</code>实现类，重写<code>Object generate(Object target, Method method, Object... params)</code>方法，配置自定义key生成器</p></blockquote></li> <li><p><code>CacheAspectSupport.findInCaches(context, key)</code> -&gt; <code>Cache.lookup(key)</code> 利用生成的缓存key检查缓存</p></li> <li></li></ol> <ul><li>（上述步骤没有缓存命中）
<ol><li>执行目标方法，返回目标数据</li> <li><code>Cache.put(key, value)</code></li></ol></li> <li>（上述步骤有缓存命中）直接返回该<code>Cache</code>对象</li></ul> <h6 id="cacheput"><a href="#cacheput" class="header-anchor">#</a> <code>CachePut</code></h6> <p>用于实现<strong>缓存双写</strong>模式解决分布式缓存一致性问题</p> <ol><li>执行目标方法，返回目标数据</li> <li><code>Cache.put(key, value)</code></li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@CachePut</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;abc&quot;</span><span class="token punctuation">,</span> key <span class="token operator">=</span> <span class="token string">&quot;#root.methodName + '[' + #result.id + ']'&quot;</span><span class="token punctuation">)</span> <span class="token comment">// @CachePut在目标方法执行后调用，故可在SpEl表达式中使用#result </span>
<span class="token keyword">public</span> <span class="token class-name">SomePOJO</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token class-name">SomePOJO</span> pojo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre></div><h6 id="cacheevict"><a href="#cacheevict" class="header-anchor">#</a> <code>CacheEvict</code></h6> <p>用于实现<strong>缓存失效</strong>模式解决分布式缓存一致性问题</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@CacheEvict</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;abc&quot;</span><span class="token punctuation">,</span> key <span class="token operator">=</span> <span class="token string">&quot;#root.methodName + '[' + #id + ']'&quot;</span><span class="token comment">/*, allEntries = true*/</span><span class="token punctuation">)</span> <span class="token comment">// allEntries属性指定是否清除该缓存组件中所有缓存key（默认为否），beforeInvocation属性指定缓存清除操作是否在方法执行之前进行（默认为否）</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">delete</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="redisautoconfiguration"><a href="#redisautoconfiguration" class="header-anchor">#</a> <code>RedisAutoConfiguration</code></h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// RedisAutoConfiguration.class</span>

<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">RedisConfiguration</span> <span class="token punctuation">{</span>
  
  <span class="token annotation punctuation">@Bean</span>
  <span class="token annotation punctuation">@ConditionalOnMissingBean</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;redisTemplate&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">public</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">redisTemplate</span><span class="token punctuation">(</span><span class="token class-name">RedisConnectionFactory</span> factory<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">UnknownHostException</span> <span class="token punctuation">{</span>
    <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> template <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    template<span class="token punctuation">.</span><span class="token function">setConnectionFactory</span><span class="token punctuation">(</span>factory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> template<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="自定义json序列化器"><a href="#自定义json序列化器" class="header-anchor">#</a> 自定义JSON序列化器</h5> <ul><li><p>配置<code>RedisTemplate</code>所使用的序列化器（编程式缓存）</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// SpringBoot 1.x</span>

<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomRedisConfiguration</span> <span class="token punctuation">{</span>
  <span class="token annotation punctuation">@Bean</span>
  <span class="token keyword">public</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">redisTemplate</span><span class="token punctuation">(</span><span class="token class-name">RedisConnectionFactory</span> factory<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">UnknownHostException</span> <span class="token punctuation">{</span>
    <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">SomePOJO</span><span class="token punctuation">&gt;</span></span> template <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    template<span class="token punctuation">.</span><span class="token function">setConnectionFactory</span><span class="token punctuation">(</span>factory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    template<span class="token punctuation">.</span><span class="token function">setDefaultSerializer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Jackson2JsonRedisSerializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> template<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>自定义<code>CacheManager</code>（声明式缓存）</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@EnableConfigurationProperties</span><span class="token punctuation">(</span><span class="token class-name">CacheProperties</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token comment">// 从配置文件中读取spring.cache配置</span>
<span class="token annotation punctuation">@EnableCaching</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomRedisCacheConfiguration</span> <span class="token punctuation">{</span>
  <span class="token comment">// 入参自动从容器中获取</span>
  <span class="token annotation punctuation">@Bean</span>
  <span class="token class-name">RedisCacheConfiguration</span> <span class="token function">redisCacheConfiguration</span><span class="token punctuation">(</span><span class="token class-name">CacheProperties</span> properties<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">RedisCacheConfiguration</span> config <span class="token operator">=</span> <span class="token class-name">RedisCacheConfiguration</span><span class="token punctuation">.</span><span class="token function">defaultCacheConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    config <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">serializeKeysWith</span><span class="token punctuation">(</span><span class="token class-name">RedisSerializationContext</span><span class="token punctuation">.</span><span class="token class-name">SerializationPair</span><span class="token punctuation">.</span><span class="token function">fromSerializer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringRedisSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    config <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">serializeKeysWith</span><span class="token punctuation">(</span><span class="token class-name">RedisSerializationContext</span><span class="token punctuation">.</span><span class="token class-name">SerializationPair</span><span class="token punctuation">.</span><span class="token function">fromSerializer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Jackson2JsonRedisSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token keyword">if</span> <span class="token punctuation">(</span>properties<span class="token punctuation">.</span>getTimeToLive <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    config <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">entryTtl</span><span class="token punctuation">(</span>properties<span class="token punctuation">.</span>getTimeToLive<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>properties<span class="token punctuation">.</span>getKeyPrefix <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 缓存key前缀，默认为cacheNames，一般使用默认值</span>
    config <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">prefixKeysWith</span><span class="token punctuation">(</span>properties<span class="token punctuation">.</span>getKeyPrefix<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>properties<span class="token punctuation">.</span><span class="token function">isCacheNullValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 缓存空值，预防缓存穿透</span>
    config <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">disableCachingNullValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>properties<span class="token punctuation">.</span><span class="token function">isUseKeyPrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    config <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">disableKeyPrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h6 id="rediscacheconfiguration"><a href="#rediscacheconfiguration" class="header-anchor">#</a> <code>RedisCacheConfiguration</code></h6> <p>采用<code>RedisCacheManager</code>作为缓存管理器，后者使用<code>RedisCache</code>进行缓存读写</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 默认读写操作不加锁</span>
<span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">lookup</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> value <span class="token operator">=</span> cacheWriter<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token function">createAndConvertCacheKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token comment">// cacheWriter.put(...)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 只有读操作有加锁版本，通过Cacheable注解的sync属性开启</span>
<span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">T</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">,</span> <span class="token class-name">Callable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> valueLoader<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token class-name">ValueWrapper</span> result <span class="token operator">=</span> <span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> result<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">valueFromLoader</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> valueLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> value<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <h1 id="amqp"><a href="#amqp" class="header-anchor">#</a> AMQP</h1> <h4 id="rabbitautoconfiguration"><a href="#rabbitautoconfiguration" class="header-anchor">#</a> <code>RabbitAutoConfiguration</code></h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// RabbitAutoConfiguration.class</span>

<span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@ConditionalOnMissingBean</span><span class="token punctuation">(</span><span class="token class-name">ConnectionFactory</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">RedisConfiguration</span> <span class="token punctuation">{</span>
  
  <span class="token annotation punctuation">@Bean</span>
  <span class="token keyword">public</span> <span class="token class-name">ConnectionFactory</span> <span class="token function">connectionFactory</span><span class="token punctuation">(</span><span class="token class-name">RabbitProperties</span> config<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token class-name">RabbitConnectionFactoryBean</span> factory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RabbitConnectionFactoryBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 设置factory各种连接属性</span>
    
    <span class="token class-name">CachingConnectionFactory</span> connectionFactory <span class="token operator">=</span> <span class="token class-name">CachingConnectionFactory</span><span class="token punctuation">(</span>factory<span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 设置connectionFactory各种连接属性</span>
    
    <span class="token keyword">return</span> connectionFactory<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">// ...</span>
  
  <span class="token annotation punctuation">@Bean</span>
  <span class="token annotation punctuation">@ConditionalOnSingleCandidate</span><span class="token punctuation">(</span><span class="token class-name">ConnectionFactory</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
  <span class="token annotation punctuation">@ConditionalOnMissingBean</span><span class="token punctuation">(</span><span class="token class-name">RabbitTemplate</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
  <span class="token keyword">public</span> <span class="token class-name">RabbitTemplate</span> <span class="token function">rabiitTemplate</span><span class="token punctuation">(</span><span class="token class-name">ConnectionFactory</span> connectionFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">RabbitTemplate</span> template <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RabbitTemplate</span><span class="token punctuation">(</span>connectionFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// ...</span>
    <span class="token keyword">return</span> template<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">// AmqpAdmin</span>
  <span class="token annotation punctuation">@Bean</span>
  <span class="token annotation punctuation">@ConditionalOnSingleCandidate</span><span class="token punctuation">(</span><span class="token class-name">ConnectionFactory</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
  <span class="token annotation punctuation">@ConditionalOnProperty</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">&quot;spring.rabbitmq&quot;</span><span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token string">&quot;dynamic&quot;</span><span class="token punctuation">,</span> matchIfMissing <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
  <span class="token annotation punctuation">@ConditionalOnMissingBean</span><span class="token punctuation">(</span><span class="token class-name">AmqpAdmin</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
  <span class="token keyword">public</span> <span class="token class-name">AmqpAdmin</span> <span class="token function">amqpAdmin</span><span class="token punctuation">(</span><span class="token class-name">ConnectionFactory</span> connectionFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">AmqpAdmin</span><span class="token punctuation">(</span>connectionFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="自定义json序列化器-2"><a href="#自定义json序列化器-2" class="header-anchor">#</a> 自定义JSON序列化器</h5> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomRabbitConfiguration</span> <span class="token punctuation">{</span>
  <span class="token annotation punctuation">@Bean</span>
  <span class="token keyword">public</span> <span class="token class-name">MessageConverter</span> <span class="token function">messageConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Jackson2JsonMessageConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="a"><a href="#a" class="header-anchor">#</a> A</h2></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
				←
				<a href="/posts/java/spring.html" class="prev">
					Spring基础
				</a></span> <span class="next"><a href="/posts/java/springmvc.html">
					Spring MVC基础
				</a>
				→
			</span></p></div> <div class="vcomment-container" data-v-07c8026b><div id="vcomments" data-v-07c8026b></div></div> </main> <!----></div><div class="global-ui"><!----><div></div></div></div>
    <script src="/assets/js/app.9bbd0500.js" defer></script><script src="/assets/js/1.7e1accfd.js" defer></script><script src="/assets/js/13.b5619b2f.js" defer></script><script src="/assets/js/23.36d5eb9b.js" defer></script>
  </body>
</html>
