<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Spring MVC基础 | Felix Mundial的杂烩图书馆</title>
    <meta name="generator" content="VuePress 1.7.1">
    <link rel="icon" href="/icons/favicon.png">
    <meta name="description" content="github page powered by Vuepress">
    
    <link rel="preload" href="/assets/css/0.styles.0e3647e7.css" as="style"><link rel="preload" href="/assets/js/app.9bbd0500.js" as="script"><link rel="preload" href="/assets/js/1.7e1accfd.js" as="script"><link rel="preload" href="/assets/js/13.b5619b2f.js" as="script"><link rel="preload" href="/assets/js/24.3d224717.js" as="script"><link rel="prefetch" href="/assets/js/10.535b18bf.js"><link rel="prefetch" href="/assets/js/11.9f4c7505.js"><link rel="prefetch" href="/assets/js/12.1040a13c.js"><link rel="prefetch" href="/assets/js/14.9065f59b.js"><link rel="prefetch" href="/assets/js/15.1af3a730.js"><link rel="prefetch" href="/assets/js/16.145ee41f.js"><link rel="prefetch" href="/assets/js/17.daef2d0a.js"><link rel="prefetch" href="/assets/js/18.ccf124a3.js"><link rel="prefetch" href="/assets/js/19.3c9e19e5.js"><link rel="prefetch" href="/assets/js/20.cbce51c7.js"><link rel="prefetch" href="/assets/js/21.aad032a5.js"><link rel="prefetch" href="/assets/js/22.d26d3f4d.js"><link rel="prefetch" href="/assets/js/23.36d5eb9b.js"><link rel="prefetch" href="/assets/js/25.e67e5f2e.js"><link rel="prefetch" href="/assets/js/26.26226ddd.js"><link rel="prefetch" href="/assets/js/27.ef309e27.js"><link rel="prefetch" href="/assets/js/28.275159e4.js"><link rel="prefetch" href="/assets/js/29.f7f84fc3.js"><link rel="prefetch" href="/assets/js/3.92bf9476.js"><link rel="prefetch" href="/assets/js/4.7de240dc.js"><link rel="prefetch" href="/assets/js/5.422f2530.js"><link rel="prefetch" href="/assets/js/6.9952df18.js"><link rel="prefetch" href="/assets/js/7.b57f400b.js"><link rel="prefetch" href="/assets/js/8.a18e3f05.js"><link rel="prefetch" href="/assets/js/9.c6f1e43f.js">
    <link rel="stylesheet" href="/assets/css/0.styles.0e3647e7.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="azure" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name"><i class="el-icon-bicycle"></i> Felix Mundial的杂烩图书馆</span></a> <div class="links"><nav class="nav-links can-hide"><div class="nav-item"><a href="/guide/toc.html" class="nav-link" data-v-c7dec8ac><i class="el-icon-discount"></i> Archives</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">算法</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/posts/leetcode/leetcode101.html" class="nav-link" data-v-c7dec8ac><i class="iconfont icon-leetcode"></i> Leetcode</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont icon-java"></i> Java</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/posts/java/concurrency.html" class="nav-link" data-v-c7dec8ac>并发</a></li><li class="dropdown-item"><!----> <a href="/posts/java/jvm.html" class="nav-link" data-v-c7dec8ac>JVM</a></li><li class="dropdown-item"><!----> <a href="/posts/java/spring.html" class="nav-link" data-v-c7dec8ac>Spring</a></li><li class="dropdown-item"><!----> <a href="/posts/java/springmvc.html" aria-current="page" class="nav-link router-link-exact-active router-link-active" data-v-c7dec8ac>Spring MVC</a></li><li class="dropdown-item"><!----> <a href="/posts/java/springboot.html" class="nav-link" data-v-c7dec8ac>Spring Boot</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont icon-database"></i> 数据库</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/posts/database/mysql.html" class="nav-link" data-v-c7dec8ac><i class="iconfont icon-mysql"></i> MySQL</a></li><li class="dropdown-item"><!----> <a href="/posts/database/redis.html" class="nav-link" data-v-c7dec8ac><i class="iconfont icon-redis"></i> Redis</a></li></ul></div></div> <!----></nav> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/guide/toc.html" class="nav-link" data-v-c7dec8ac><i class="el-icon-discount"></i> Archives</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">算法</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/posts/leetcode/leetcode101.html" class="nav-link" data-v-c7dec8ac><i class="iconfont icon-leetcode"></i> Leetcode</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont icon-java"></i> Java</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/posts/java/concurrency.html" class="nav-link" data-v-c7dec8ac>并发</a></li><li class="dropdown-item"><!----> <a href="/posts/java/jvm.html" class="nav-link" data-v-c7dec8ac>JVM</a></li><li class="dropdown-item"><!----> <a href="/posts/java/spring.html" class="nav-link" data-v-c7dec8ac>Spring</a></li><li class="dropdown-item"><!----> <a href="/posts/java/springmvc.html" aria-current="page" class="nav-link router-link-exact-active router-link-active" data-v-c7dec8ac>Spring MVC</a></li><li class="dropdown-item"><!----> <a href="/posts/java/springboot.html" class="nav-link" data-v-c7dec8ac>Spring Boot</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont icon-database"></i> 数据库</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/posts/database/mysql.html" class="nav-link" data-v-c7dec8ac><i class="iconfont icon-mysql"></i> MySQL</a></li><li class="dropdown-item"><!----> <a href="/posts/database/redis.html" class="nav-link" data-v-c7dec8ac><i class="iconfont icon-redis"></i> Redis</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Java</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/posts/java/concurrency.html" class="sidebar-link">Java并发</a></li><li><a href="/posts/java/jvm.html" class="sidebar-link">JVM</a></li><li><a href="/posts/java/spring.html" class="sidebar-link">Spring基础</a></li><li><a href="/posts/java/springboot.html" class="sidebar-link">Spring Boot基础</a></li><li><a href="/posts/java/springmvc.html" aria-current="page" class="active sidebar-link">Spring MVC基础</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/posts/java/springmvc.html#基本概念" class="sidebar-link">基本概念</a></li><li class="sidebar-sub-header"><a href="/posts/java/springmvc.html#请求处理流程" class="sidebar-link">请求处理流程</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="post-header" data-v-528c0c8a><h2 class="post-title" data-v-528c0c8a><a href="/posts/java/springmvc.html" data-v-528c0c8a><!---->
			Spring MVC基础
		</a></h2> <div class="post-meta" data-v-528c0c8a><div class="author post-meta-item" data-v-528c0c8a><i class="el-icon-bicycle" data-v-528c0c8a></i> <span data-v-528c0c8a>FelixMundial</span></div> <div class="time post-meta-item" data-v-528c0c8a><i class="el-icon-time" data-v-528c0c8a></i> <time data-v-528c0c8a>2020-11-11</time></div> <div class="category post-meta-item" data-v-528c0c8a><i class="el-icon-collection" data-v-528c0c8a></i> <a href="/category/Spring" class="category-item" data-v-528c0c8a>
				Spring
			</a></div> <div class="tags post-meta-item" data-v-528c0c8a><i class="el-icon-price-tag" data-v-528c0c8a></i> <span class="tag-item el-tag el-tag--light" data-v-528c0c8a>
				Spring
			</span></div> <div id="/posts/java/springmvc.html" data-flag-title="Spring MVC基础" class="leancloud-visitors post-meta-item" data-v-528c0c8a><i class="el-icon-reading" data-v-528c0c8a></i> <span class="leancloud-visitors-count" data-v-528c0c8a>0</span></div></div></div> <div class="theme-default-content content__default"><h1 id="spring-mvc"><a href="#spring-mvc" class="header-anchor">#</a> Spring MVC</h1> <h2 id="基本概念"><a href="#基本概念" class="header-anchor">#</a> 基本概念</h2> <ul><li>转发与重定向页面字符串不经过视图解析器处理，无拼串过程；其中<code>/</code>表示项目根路径</li> <li>视图对象是无状态的，因此不会有线程安全问题</li></ul> <h4 id="bindingawaremodelmap-隐含模型"><a href="#bindingawaremodelmap-隐含模型" class="header-anchor">#</a> <code>BindingAwareModelMap</code>（“隐含模型”）</h4> <ul><li>控制器方法的返回值可以为<code>ModelAndView</code>类型，该对象既包含视图信息，又包含模型数据信息，其中模型数据信息置于<code>request</code>域中
<ul><li>在<code>Controller</code>类上标注<code>@SessionAttributes</code>注解，可将（<code>value</code>或<code>type</code>属性指定的）模型数据信息置于**<code>request</code>域以及<code>session</code>域**中</li></ul></li> <li><code>@ModelAttribute</code>标注的方法在控制器方法前运行，与控制器方法共享同一个<code>BindingAwareModelMap</code>对象</li></ul> <h3 id="注意事项"><a href="#注意事项" class="header-anchor">#</a> 注意事项</h3> <h5 id="controller获取前端传入的请求参数"><a href="#controller获取前端传入的请求参数" class="header-anchor">#</a> Controller获取前端传入的请求参数</h5> <h6 id="get"><a href="#get" class="header-anchor">#</a> <code>GET</code></h6> <h6 id="post"><a href="#post" class="header-anchor">#</a> <code>POST</code></h6> <p><code>application/json</code>：使用<code>@RequestBody</code><strong>对象</strong>接收</p> <p><code>x-www-form-urlencoded</code>：使用<code>HttpServletRequest</code>获取请求参数，亦可直接使用POJO、<code>@RequestBody</code><strong>字符串</strong>，或<code>HttpEntity&lt;T&gt;</code>对象（可以获取所有请求头）接收</p> <h5 id="数据格式化与数据校验"><a href="#数据格式化与数据校验" class="header-anchor">#</a> 数据格式化与数据校验</h5> <ul><li>在POJO字段上添加格式规则注解</li> <li>使用JSR 303实现类，在POJO字段上添加校验规则注解，在<code>Controller</code>方法入参处添加<code>@Valid</code>/<code>@Validated</code>注解（标注该注解的入参后紧跟<code>BindingResult</code>对象，封装校验结果）</li></ul> <h5 id="异常处理"><a href="#异常处理" class="header-anchor">#</a> 异常处理</h5> <h5 id="handlerexceptionresolver"><a href="#handlerexceptionresolver" class="header-anchor">#</a> <code>HandlerExceptionResolver</code></h5> <ul><li><code>ExceptionHandlerExceptionResolver</code></li> <li><code>ResponseStatusExceptionResolver</code></li> <li><code>DefaultHandlerExceptionResolver</code> 处理部分预设异常</li></ul> <h5 id="支持restful请求方法"><a href="#支持restful请求方法" class="header-anchor">#</a> 支持RESTful请求方法</h5> <p>配置<code>HiddenHttpMethodFilter</code></p> <p>前端携带<code>_method</code>参数，参数值为<code>delete</code>或<code>put</code>（在过滤器中统一转为大写）</p> <blockquote><p><code>HttpMethodRequestWrapper</code>重写了父类<code>HttpServletRequest</code>的<code>getMethod()</code>方法，将传入的（而非request本身的）方法参数封装为新的请求方法对外返回</p></blockquote> <h2 id="请求处理流程"><a href="#请求处理流程" class="header-anchor">#</a> 请求处理流程</h2> <h4 id="spring-mvc九大组件"><a href="#spring-mvc九大组件" class="header-anchor">#</a> Spring MVC九大组件</h4> <ul><li><code>MultipartResolver</code></li> <li><code>LocaleResolver</code></li> <li><code>ThemeResolver</code></li> <li><code>HandlerMapping</code>集合</li> <li><code>HandlerAdapter</code>集合</li> <li><code>HandlerExceptionResolver</code>集合</li> <li><code>ThemeResolver</code></li> <li><code>RequestToViewNameTranslator</code></li> <li><code>FlashMapManager</code></li> <li><code>ViewResolver</code>集合</li></ul> <h4 id="处理器处理请求映射及视图解析器解析页面字符串流程-spring-4-x旧版本"><a href="#处理器处理请求映射及视图解析器解析页面字符串流程-spring-4-x旧版本" class="header-anchor">#</a> 处理器处理请求映射及视图解析器解析页面字符串流程（Spring 4.x旧版本）</h4> <ol><li>客户端（浏览器）发送请求，最终请求至 <code>DispatcherServlet</code></li> <li><code>DispatcherServlet</code> 根据请求信息调用 <code>HandlerMapping</code>，解析请求对应的 <code>Handler</code></li> <li>解析对应的 <code>Handler</code>，交由对应 <code>HandlerAdapter</code> 适配器处理</li> <li><code>HandlerAdapter#handle(...)</code> 处理目标请求，执行业务逻辑</li> <li>处理器返回 <code>ModelAndView</code> 对象通过适配器传递给<code>DispaterServlet</code>，其中<code>Model</code> 是返回的数据对象，<code>View</code> 为逻辑View</li> <li><code>ViewResolver</code> 根据逻辑View查找实际 <code>View</code></li> <li><code>DispaterServlet</code> 将返回的 <code>Model</code> 传给 <code>View</code>（视图渲染）</li> <li><code>DispaterServlet</code>将 <code>View</code> 返回给请求者（浏览器）</li></ol> <div class="language-sequence extra-class"><pre class="language-text"><code>participant HttpServlet
participant HttpServletBean
participant FrameworkServlet
participant DispatcherServlet

note over HttpServlet: doGet(req, res)/doPost(req, res)
note over FrameworkServlet: processRequest(req, res)
note over DispatcherServlet: doService(req, res) -&gt; doDispatch(req, res)

</code></pre></div><h6 id="dispatcherservlet-dodispatch-req-res"><a href="#dispatcherservlet-dodispatch-req-res" class="header-anchor">#</a> <code>DispatcherServlet.doDispatch(req, res)</code></h6> <ol><li><p><code>checkMultipart(req)</code>，判断是否为文件上传请求</p></li> <li><p><code>getHandler(processedRequest)</code>，获取能处理当前请求的控制器/处理器（若没有符合条件的控制器/处理器，则重定向至404页面，除非用户在配置中显式要求抛出<code>NoHandlerFoundException</code>），其中包含请求所经过的拦截器信息<code>interceptorList</code></p> <blockquote><p>该方法遍历<code>HandlerMapping[]</code>（处理器映射），获取控制器方法映射信息，构造<code>HandlerExecutionChain</code>对象返回</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// getHandler()</span>

<span class="token comment">// XXXHandlerMapping中保存有不同请求映射信息的(LinkedHashMap) handlerMap属性</span>
<span class="token keyword">for</span><span class="token punctuation">(</span>handlerMapping hm<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handlerMappings<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">// ...</span>
<span class="token class-name">HandlerExecutionChain</span> handler <span class="token operator">=</span> hm<span class="token punctuation">.</span><span class="token function">getHandler</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// return handler</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>（优先匹配）动态方法对应<code>DefaultAnnotationHandlerMapping</code>或<code>RequestMethodHandlerMapping</code>对，<code>handlerMap</code>/<code>urlMapping</code>属性中保存有控制器方法（动态方法）请求映射信息（<code>/xxx=XXXController@addr</code>），需要借助<code>&lt;mvc:annotation-driven&gt;</code>实现</li> <li>静态资源对应<code>SimpleUrlHandlerMapping</code>对象，<code>handlerMap</code>属性中保存有（其他）请求的映射信息（<code>/**=DefaultServletHttpRequestHandler@addr</code>，即所有请求直接由Tomcat接管），需要借助<code>&lt;mvc:default-servlet-handler&gt;</code>实现</li></ul></blockquote></li> <li><p><code>getHandlerAdapter(mappedHandler.getHandler())</code>，获取能执行控制器方法的适配器<code>ha</code></p> <blockquote><p>该方法从<code>HandlerAdapter[]</code>中遍历控制器方法适配器（<code>HttpRequestHandlerAdapter</code>/<code>SimpleControllerHandlerAdapter</code>/<code>AnnotationMethodHandlerAdapter</code>），如果适配器支持当前处理器，则返回该适配器</p></blockquote></li> <li><p><code>!mappedHandler.applyPreHandle(processedRequest, response)</code>，遍历<code>interceptorList</code>进行<code>preHandle()</code>方法调用（启用多个拦截器时，不论是否有拦截器不放行请求，已放行拦截器的<code>afterCompletion()</code>方法都会执行）</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">boolean</span> <span class="token function">applyPreHandle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> req<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> res<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getInterceptors</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">getInterceptors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">HandlerIntercoptor</span> interceptor <span class="token operator">=</span> <span class="token function">getInterceptors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>interceptor<span class="token punctuation">.</span><span class="token function">preHandle</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handler<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">triggerAfterCompletion</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>interceptorIndex <span class="token operator">=</span> i<span class="token punctuation">;</span> <span class="token comment">//	已有i个拦截器正常执行</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p><code>mv = ha.handle(processedRequest, response, mappedHandler.getHandler())</code>，适配器<code>ha</code>执行目标方法，返回<code>ModelAndView</code>对象（自动封装可能返回的视图名字符串）</p> <blockquote><p>目标控制器方法的反射执行流程：</p> <ol><li><p><code>ha.handle(processedRequest, response, mappedHandler.getHandler())</code></p> <p>判断是否标注有<code>SessionAttribute</code>注解，若存在则放入<code>SessionAttributeStore</code></p></li> <li><p><code>invokeHandlerMethod(processedRequest, response, mappedHandler)</code></p> <ol><li>获取当前处理器的<code>ServletHandlerMethodResolver</code></li> <li>通过方法解析器定位当前请求对应的控制器方法</li> <li>创建<code>ServletHandlerMethodInvoker</code>和<code>BindingAwareModelMap</code>对象</li></ol></li> <li><p><code>HandlerMethodInvoker.invokeHandlerMethod(handlerMethod, handler, webRequest, implicitModel)</code></p> <ol><li><p>遍历所有<code>SessionAttribute</code>名，将<code>SessionAttributeStore</code>中存在的<code>SessionAttribute</code>放入<code>implicitModel</code>对象</p></li> <li><p>遍历所有<code>ModelAttributeMethod</code>，获取<code>ModelAttributeMethod</code>方法的参数：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args <span class="token operator">=</span> <span class="token function">resolveHandlerArguments</span><span class="token punctuation">(</span>attributeMethodToInvoke<span class="token punctuation">,</span> handler<span class="token punctuation">,</span> webRequest<span class="token punctuation">,</span> implicitModel<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ol><li>解析<code>@ModelAttribute</code>方法的参数（参见下一节加粗部分）</li> <li>根据<code>@ModelAttribute</code>注解中<code>value</code>属性值确定<code>attrName</code>（若未显式配置该属性则赋值为方法返回值首字母小写字符串），并放入<code>implicitModel</code>对象</li> <li>传入<code>args[]</code>数组，反射执行<code>@ModelAttribute</code>方法（<code>attributeMethodToInvoke</code>）</li></ol></li> <li><p>再次调用<code>resolveHandlerArguments(attributeMethodToInvoke, handler, webRequest, implicitModel)</code>获取目标控制器方法的参数，并真正通过反射执行目标控制器方法</p> <blockquote><p><strong>解析方法参数的流程（原始）：</strong></p> <ol><li><p>创建<code>args[]</code>数组，长度为<code>method.getParameterTypes()</code>长度</p></li> <li><p>遍历方法参数，尝试获取参数信息：</p> <ol><li><p>若标有注解，则对每一类型的注解分别进行判断，返回对应不同类型注解的成员变量</p></li> <li><p>若某一参数没找到任何注解信息：</p> <ol><li><p>判断该参数是否为<code>Servlet</code>原生组件对象</p></li> <li><p>判断是否为<code>Model</code>或<code>Map</code>实现类，若是则将<code>implicitModel</code>对象赋值给<code>args[]</code>对应元素</p></li> <li><p>判断是否为其他类型的原生<code>api</code>（<code>SessionStatus</code>/<code>HttpEntity</code>/<code>Errors</code>）</p></li> <li><p>判断该参数是否为简单类型（基本类型对象），若是则将<code>paramName</code>赋为空串</p></li> <li><p>若参数为<code>POJO</code>类型，则将<code>attrName</code>赋为空串</p> <blockquote><div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 将控制器方法的入参信息传递给WebDataBinderFactory工厂对象，创建DataBinder实例</span>
<span class="token class-name">WebDataBinder</span> <span class="token function">resolveModelAttribute</span><span class="token punctuation">(</span>attrName<span class="token punctuation">,</span> methodParam<span class="token punctuation">,</span> implicitModel<span class="token punctuation">,</span> webRequest<span class="token punctuation">,</span> handler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">// 若attrName为空串，则赋值为参数类型首字母小写</span>
<span class="token comment">// 将封装的参数对象赋值给bindObject返回</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>封装<code>POJO</code>类型<code>bindObject</code>对象流程：</p> <ol><li>在<code>implicitModel</code>中寻找<code>key</code>为<code>attrName</code>的对象，若存在则赋值给<code>bindObject</code>返回</li> <li>若该属性标注有<code>SessionAttribute</code>注解，则尝试从<code>Session</code>中获取<code>value</code>属性标注的对象或<code>key</code>为<code>attrName</code>的对象</li> <li>否则利用反射创建名为<code>attrName</code>值的空<code>POJO</code>对象</li></ol></blockquote> <p>使用<code>doBind(webDataBinder, webRequest, ...)</code>方法，使用请求参数对上述对象中的属性进行一一绑定</p> <blockquote><p><strong>请求参数绑定流程</strong>：</p> <ol><li><p><code>DataBinder</code>调用<code>ConversionService</code>对象进行数据类型转换与数据格式化，并进行入参对象的属性绑定</p> <blockquote><p>自定义类型转换器：</p> <ol><li>实现<code>Converter</code>接口</li> <li>注册自定义<code>FormattingConversionServiceFactoryBean</code></li> <li>可在<code>&lt;mvc:annotiation-driven&gt;</code>属性中配置自定义的<code>ConversionService</code></li></ol></blockquote></li> <li><p><code>DataBinder</code>调用多个<code>Validator</code>对象对已经完成属性绑定的入参对象进行数据合法性校验，数据绑定结果保存至<code>BindingResult</code>对象中</p></li></ol></blockquote></blockquote></li></ol></li> <li><p>根据上一步返回的参数信息（标有注解时根据注解信息确定参数值，否则返回上一步中所得到的对象），将参数对象放入<code>args[]</code>的对应元素中</p></li></ol></li> <li><p>传入<code>args[]</code>数组，真正反射执行目标控制器方法</p></li></ol></blockquote></li></ol></li></ol></blockquote></li> <li><p><code>mappedHandler.applyPostHandle(processedRequest, response, mv)</code> 逆序执行（已完成的）拦截器的<code>postHandle()</code>方法</p></li> <li><p><code>processDispatchResult(processedRequest, response, mappedHandler, mv, dispatchException)</code>，转发到目标页面</p> <ol><li><p>若有异常传入，先处理异常</p> <div class="language-java extra-class"><pre class="language-java"><code>mv <span class="token operator">=</span> <span class="token function">processHandlerException</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> handler<span class="token punctuation">,</span> exception<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 遍历所有HandlerExceptionHander进行异常解析</span>
</code></pre></div></li> <li><p><code>render(mv, req, res)</code></p></li> <li><p><code>View view = resolveViewName(mv.getViewName, mv.getModelInternal, locale, req)</code></p></li> <li><p><code>View view = viewResolver.resolveViewName(viewName, locale)</code></p> <p>遍历所有可用的视图解析器（默认即为<code>InternalResourceViewResolver</code>，优先级最低）根据视图名获取<code>View</code>对象（<code>RedirectView</code>/<code>InternalResourceView</code>）：</p> <ol><li>从<code>this.ViewCreationCache</code>中尝试获取<code>View</code>对象</li> <li><code>View view = createView(viewName, locale)</code></li> <li>进行实际的前后缀拼串过程</li> <li>将<code>View</code>对象放入<code>this.ViewCreationCache</code></li></ol></li> <li><p><code>view.render(mv.getModelInternal, req, res)</code> 转发到目标页面</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> mergedModel <span class="token operator">=</span> <span class="token function">createMergedOutputModel</span><span class="token punctuation">(</span>model<span class="token punctuation">,</span> req<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">prepareResponse</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">renderMergedOutputModel</span><span class="token punctuation">(</span>mergedModel<span class="token punctuation">,</span> req<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 对需要在页面展示的ModelMap进行渲染</span>
</code></pre></div><blockquote><p><code>renderMergedOutputModel(mergedModel, req, res)</code>：</p> <ol><li><code>exposeModelAsRequestAttribute(model, requetsToExpose)</code> 将<code>model</code>中的各属性放入<code>request</code>中</li> <li>获取视图地址和<code>Servlet</code>原生转发器（<code>RequestDispatcher</code>）</li> <li><code>requestDispatcher.forward(requestToExpose, response)</code></li></ol></blockquote></li> <li><p>若页面正常处理，执行<code>afterCompletion()</code>方法</p></li></ol></li> <li><p>若上述步骤出现异常，则在<code>catch</code>块执行<code>afterCompletion()</code>方法（<code>afterCompletion()</code>方法总会执行）</p></li></ol> <h6 id="mvc-annotation-driven"><a href="#mvc-annotation-driven" class="header-anchor">#</a> <code>&lt;mvc:annotation-driven&gt;</code></h6> <ul><li>自动注册<code>RequestMappingHandlerMapping</code>/<code>RequestMappingHandlerAdaptor</code>/<code>ExceptionHandlerExceptionResolver</code>三个组件</li> <li><code>AnnotationDrivenBeanDefinitionParser</code>解析<code>&lt;mvc:annotation-driven&gt;</code>标签</li></ul> <h6 id="httpmessageconverter"><a href="#httpmessageconverter" class="header-anchor">#</a> <code>HttpMessageConverter</code></h6> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// HttpMessageConverter</span>
<span class="token keyword">boolean</span> <span class="token function">canRead</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">MediaType</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">boolean</span> <span class="token function">canWrite</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">MediaType</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
list<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MediaType</span><span class="token punctuation">&gt;</span></span> <span class="token function">getSupportedMediaTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">T</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">HttpInputMessage</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 如@RequestBody封装对象流程</span>
<span class="token keyword">void</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">MediaType</span><span class="token punctuation">,</span> <span class="token class-name">HttpOutputMessage</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 如@ResponseBody返回数据</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
				←
				<a href="/posts/java/springboot.html" class="prev">
					Spring Boot基础
				</a></span> <!----></p></div> <div class="vcomment-container" data-v-07c8026b><div id="vcomments" data-v-07c8026b></div></div> </main> <!----></div><div class="global-ui"><!----><div></div></div></div>
    <script src="/assets/js/app.9bbd0500.js" defer></script><script src="/assets/js/1.7e1accfd.js" defer></script><script src="/assets/js/13.b5619b2f.js" defer></script><script src="/assets/js/24.3d224717.js" defer></script>
  </body>
</html>
