(window.webpackJsonp=window.webpackJsonp||[]).push([[14],{598:function(_,v,a){_.exports=a.p+"assets/img/index_innodb.647303ec.jpg"},599:function(_,v,a){_.exports=a.p+"assets/img/index_myisam.ef96c4b2.jpg"},617:function(_,v,a){"use strict";a.r(v);var t=a(24),s=Object(t.a)({},(function(){var _=this,v=_.$createElement,t=_._self._c||v;return t("ContentSlotsDistributor",{attrs:{"slot-key":_.$parent.slotKey}},[t("h1",{attrs:{id:"索引"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#索引"}},[_._v("#")]),_._v(" 索引")]),_._v(" "),t("h3",{attrs:{id:"索引类型"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#索引类型"}},[_._v("#")]),_._v(" 索引类型")]),_._v(" "),t("h5",{attrs:{id:"innodb索引"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#innodb索引"}},[_._v("#")]),_._v(" InnoDB索引")]),_._v(" "),t("ul",[t("li",[t("p",[_._v("聚簇索引（聚集索引）")]),_._v(" "),t("ul",[t("li",[_._v("主键索引")])])]),_._v(" "),t("li",[t("p",[_._v("辅助索引（二级索引）")]),_._v(" "),t("ul",[t("li",[_._v("单值索引")]),_._v(" "),t("li",[_._v("复合索引（联合索引 -> 覆盖索引）")]),_._v(" "),t("li",[_._v("唯一索引（可升级为聚簇索引）")])])])]),_._v(" "),t("p",[t("img",{attrs:{src:a(598),alt:"img"}})]),_._v(" "),t("p",[t("img",{attrs:{src:a(599),alt:"img"}})]),_._v(" "),t("blockquote",[t("ul",[t("li",[t("p",[_._v("聚簇索引具有唯一性")])]),_._v(" "),t("li",[t("p",[_._v("聚簇索引树按照主键顺序依次存放数据，故使用自增主键，插入数据时无需移动旧数据，效率高")])]),_._v(" "),t("li",[t("p",[_._v("InnoDB聚簇索引的优势：")]),_._v(" "),t("ul",[t("li",[_._v("主键和行数据存储在同一棵B+树，一同被载入内存，当获取行数据时IO次数更少")]),_._v(" "),t("li",[_._v("辅助索引的叶子节点存储"),t("strong",[_._v("主键值")]),_._v("，而非数据的物理地址（MyISAM非聚簇索引方案），当行数据发生可能的移动或页分裂时无需对辅助索引树进行额外维护")])]),_._v(" "),t("p",[t("strong",[_._v("辅助索引 -> 辅助索引 -> 主键值 -> 聚簇索引树 -> 行数据")]),_._v("的查询过程称作“回表”")])])])]),_._v(" "),t("h3",{attrs:{id:"索引结构"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#索引结构"}},[_._v("#")]),_._v(" 索引结构")]),_._v(" "),t("ul",[t("li",[_._v("BTree/B+Tree/B*Tree")]),_._v(" "),t("li",[_._v("Hash（InnoDB、MyISAM均不支持）")]),_._v(" "),t("li",[_._v("Full-Text（MyISAM支持）")]),_._v(" "),t("li",[_._v("RTree（MyISAM支持）")])]),_._v(" "),t("blockquote",[t("p",[t("strong",[_._v("使用B+树的优势")])]),_._v(" "),t("ul",[t("li",[_._v("数据统一存储在叶子节点中，每个节点存储的key数量更多；查询深度稳定")]),_._v(" "),t("li",[_._v("叶子节点维护有序链表，区间查询性能较好")])]),_._v(" "),t("p",[t("strong",[_._v("不适用索引的场合")])]),_._v(" "),t("ul",[t("li",[_._v("表数据量较少")]),_._v(" "),t("li",[_._v("表字段频繁更新")]),_._v(" "),t("li",[_._v("表字段使用频次较少")])])]),_._v(" "),t("h6",{attrs:{id:"索引高度"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#索引高度"}},[_._v("#")]),_._v(" 索引高度")]),_._v(" "),t("p",[_._v("索引树高度应维持在3～4之间")]),_._v(" "),t("h3",{attrs:{id:"索引设计策略"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#索引设计策略"}},[_._v("#")]),_._v(" 索引设计策略")]),_._v(" "),t("ol",[t("li",[_._v("数据行数过多\n"),t("ul",[t("li",[_._v("分库分表")])])]),_._v(" "),t("li",[_._v("字段长度过长或类型空间占用过长\n"),t("ul",[t("li",[_._v("字符串列尽量采用前缀索引\n"),t("ul",[t("li",[_._v("减小索引字段大小，增加页中存储索引量，有效提高索引查询速度")]),_._v(" "),t("li",[t("code",[_._v("order by")]),_._v("语句无法使用前缀索引")])])]),_._v(" "),t("li",[_._v("尽量使用"),t("code",[_._v("VARCHAR")])]),_._v(" "),t("li",[_._v("尽量使用"),t("code",[_._v("ENUM")]),_._v("作为常量值")])])])]),_._v(" "),t("h1",{attrs:{id:"sql优化"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#sql优化"}},[_._v("#")]),_._v(" SQL优化")]),_._v(" "),t("div",{staticClass:"language-mysql extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[_._v("# set global slow_query_log='ON'; // 开启慢 SQL 日志\n# set global slow_query_log_file='/var/lib/mysql/test-slow.log'; // 记录日志地址\n# set global long_query_time=1; // 最大执行时间\nshow variables like 'slow_query%';\nshow variables like 'long_query_time';\n")])])]),t("h2",{attrs:{id:"执行计划"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#执行计划"}},[_._v("#")]),_._v(" 执行计划")]),_._v(" "),t("p",[t("code",[_._v("id")])]),_._v(" "),t("p",[t("code",[_._v("select_type")])]),_._v(" "),t("p",[t("code",[_._v("table")])]),_._v(" "),t("p",[t("code",[_._v("type")])]),_._v(" "),t("ul",[t("li",[t("p",[t("code",[_._v("ALL")]),_._v("全表扫描")])]),_._v(" "),t("li",[t("p",[t("code",[_._v("INDEX")]),_._v("全索引扫描")]),_._v(" "),t("ul",[t("li",[_._v("需要遍历整棵索引树")])])]),_._v(" "),t("li",[t("p",[t("code",[_._v("RANGE")]),_._v("索引范围扫描")]),_._v(" "),t("ul",[t("li",[t("code",[_._v("OR")]),_._v("/"),t("code",[_._v("IN")]),_._v("查询无法直接沿叶子节点指针遍历获取结果集，执行效率低，需优化为"),t("code",[_._v("UNION")])]),_._v(" "),t("li",[_._v("聚簇索引的不等值查询类型为"),t("code",[_._v("RANGE")]),_._v("，辅助索引的不等值查询类型为"),t("code",[_._v("ALL")])])])]),_._v(" "),t("li",[t("p",[t("code",[_._v("REF")]),_._v("非唯一索引等值查询，及唯一索引最左原则匹配扫描（❓）")])]),_._v(" "),t("li",[t("p",[t("code",[_._v("EQ_REF")])]),_._v(" "),t("ul",[t("li",[_._v("常见于多表连接中使用主键和唯一索引作为关联条件的场景，此时被驱动（连接）的表（子表，左表❓）连接字段应为主键或唯一索引，执行计划类型为EQ_REF")])])]),_._v(" "),t("li",[t("p",[t("code",[_._v("CONST")]),_._v("主键/唯一键的等值查询（在索引树第一层即发生索引命中）")])])]),_._v(" "),t("p",[t("code",[_._v("possible_keys")])]),_._v(" "),t("p",[t("code",[_._v("key")])]),_._v(" "),t("p",[t("code",[_._v("key_len")]),_._v("索引覆盖长度")]),_._v(" "),t("ul",[t("li",[t("p",[_._v("单值索引")]),_._v(" "),t("ul",[t("li",[_._v("对于可能为NULL的字符字段，覆盖长度为"),t("strong",[_._v("1")]),_._v("（用于标识是否为空的预留字节）"),t("strong",[_._v("+2")]),_._v("（用于标识"),t("code",[_._v("VARCHAR")]),_._v("类型的开始与结束位置）"),t("strong",[_._v("+字符长度✖️单字符最大预留字节长度")]),_._v("（编码为utf8mb4时最大预留字节长度为4，编码为utf8时最大预留字节长度为3）")]),_._v(" "),t("li",[_._v("索引覆盖长度应尽可能短（以节省索引树叶子节点空间占用）")])])]),_._v(" "),t("li",[t("p",[_._v("复合索引")]),_._v(" "),t("ul",[t("li",[_._v("索引覆盖长度应尽可能长（以尽可能多地使用复合索引）")])])])]),_._v(" "),t("p",[t("code",[_._v("ref")])]),_._v(" "),t("p",[t("code",[_._v("rows")])]),_._v(" "),t("p",[t("code",[_._v("Extra")])]),_._v(" "),t("h2",{attrs:{id:"执行性能"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#执行性能"}},[_._v("#")]),_._v(" 执行性能")]),_._v(" "),t("h4",{attrs:{id:"show-profiles"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#show-profiles"}},[_._v("#")]),_._v(" "),t("code",[_._v("SHOW PROFILES")])]),_._v(" "),t("div",{staticClass:"language-mysql extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[_._v("SHOW PROFILE [type [, type] ... ]\n[FOR QUERY n]\n[LIMIT row_count [OFFSET offset]]\n")])])]),t("h4",{attrs:{id:"show-processlist"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#show-processlist"}},[_._v("#")]),_._v(" "),t("code",[_._v("SHOW PROCESSLIST")])]),_._v(" "),t("h2",{attrs:{id:"索引优化策略"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#索引优化策略"}},[_._v("#")]),_._v(" 索引优化策略")]),_._v(" "),t("h4",{attrs:{id:"单表"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#单表"}},[_._v("#")]),_._v(" 单表")]),_._v(" "),t("ol",[t("li",[t("p",[t("strong",[_._v("覆盖索引")]),_._v("与"),t("strong",[_._v("最左前缀规则")])]),_._v(" "),t("ol",[t("li",[t("p",[_._v("（执行等值查询时）"),t("strong",[_._v("查询条件字段应从（复合）索引的最左前列进行，且被索引完全覆盖")]),_._v("，可避免回表。即，查询条件字段不跳过可用索引中的"),t("strong",[_._v("任何")]),_._v("列（且不能在索引中的任何列上使用范围查询、按照范围查询的字段不能被索引覆盖），或是索引字段的子集。若发生索引中断，索引覆盖长度只取决于中断前的索引字段")]),_._v(" "),t("blockquote",[t("p",[t("strong",[_._v("当查询条件字段被索引完全覆盖时")]),_._v("，即使字段排列顺序与索引顺序不一致也能使用索引（查询优化器将按照索引顺序对字段排列顺序进行调整）：因此在实际使用时，唯一值较多的字段排列顺序应尽量在前（有可能过滤更大比例的数据）")])])]),_._v(" "),t("li",[t("p",[_._v("（索引字段用于排序或分组时）"),t("strong",[_._v("排序字段的顺序须与索引字段严格一致，也应从索引的最左前列进行（除非某个排序字段为常量），且方向一致")]),_._v("，此时直接依赖索引进行结果集排序，不产生"),t("code",[_._v("using filesort")]),_._v("（而是"),t("code",[_._v("using index")]),_._v("），但排序/分组时所依赖索引的覆盖长度不在执行计划key_len中体现")])])])]),_._v(" "),t("li",[t("p",[t("strong",[_._v("索引失效避免")])]),_._v(" "),t("ol",[t("li",[_._v("查询结果集数据量尽量小（占原表的25%以下，否则可能不会使用索引）")]),_._v(" "),t("li",[_._v("不在索引列上做任何二次加工操作")]),_._v(" "),t("li",[_._v("模糊查询时%写在查询关键词右侧")]),_._v(" "),t("li",[t("code",[_._v("VARCHAR")]),_._v("类型字段须加上单引号，否则无法使用索引，也可能导致行锁降级为表锁")])])]),_._v(" "),t("li",[t("p",[_._v("不直接对大表进行"),t("code",[_._v("COUNT(*)")]),_._v("/"),t("code",[_._v("COUNT(1)")]),_._v("行数统计操作，而使用执行计划中ROWS近似值代替，或额外维护一份汇总表；若此时表中存在辅助索引，优化器将借助辅助索引统计行数，一定程度上减少I/O操作")])])]),_._v(" "),t("h4",{attrs:{id:"多表"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#多表"}},[_._v("#")]),_._v(" 多表")]),_._v(" "),t("ol",[t("li",[_._v("小表驱动（连接）大表：驱动表查询时无法沿索引查找（"),t("code",[_._v("ALL")]),_._v("），故数据量应尽可能少；小表上关联列上不建立索引")]),_._v(" "),t("li",[_._v("子表上的被连接字段需要添加索引，或直接使用主键索引作为被连接字段")])]),_._v(" "),t("h5",{attrs:{id:"排序-分组"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#排序-分组"}},[_._v("#")]),_._v(" 排序/分组")]),_._v(" "),t("blockquote",[t("p",[_._v("单路复用排序中是否出现"),t("code",[_._v("sort_buffer_size")]),_._v("/"),t("code",[_._v("max_length_for_sort_data")]),_._v("瓶颈❓")])]),_._v(" "),t("h1",{attrs:{id:"innodb执行引擎"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#innodb执行引擎"}},[_._v("#")]),_._v(" InnoDB执行引擎")]),_._v(" "),t("h3",{attrs:{id:"逻辑架构"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#逻辑架构"}},[_._v("#")]),_._v(" 逻辑架构")]),_._v(" "),t("ul",[t("li",[_._v("连接层")]),_._v(" "),t("li",[_._v("服务层")]),_._v(" "),t("li",[_._v("引擎层")]),_._v(" "),t("li",[_._v("存储层")])]),_._v(" "),t("h3",{attrs:{id:"并发事务"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#并发事务"}},[_._v("#")]),_._v(" 并发事务")]),_._v(" "),t("h4",{attrs:{id:"隔离级别"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#隔离级别"}},[_._v("#")]),_._v(" 隔离级别")]),_._v(" "),t("ul",[t("li",[t("p",[_._v("读未提交（RU）")]),_._v(" "),t("p",[_._v("存在脏读、不可重复读及幻读问题")])]),_._v(" "),t("li",[t("p",[_._v("读已提交（RC）")]),_._v(" "),t("p",[_._v("存在不可重复读及幻读问题")])]),_._v(" "),t("li",[t("p",[_._v("可重复读（RR）")]),_._v(" "),t("p",[_._v("仍存在幻读问题")])]),_._v(" "),t("li",[t("p",[_._v("可序列化（S）")])])]),_._v(" "),t("h4",{attrs:{id:"锁机制"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#锁机制"}},[_._v("#")]),_._v(" 锁机制")]),_._v(" "),t("ul",[t("li",[_._v("共享锁（S）")]),_._v(" "),t("li",[_._v("排他锁（X）")]),_._v(" "),t("li",[_._v("意向共享锁（IS）")]),_._v(" "),t("li",[_._v("意向排他锁（IX）")])]),_._v(" "),t("h5",{attrs:{id:"innodb解决rr级别下的幻读问题"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#innodb解决rr级别下的幻读问题"}},[_._v("#")]),_._v(" InnoDB解决RR级别下的幻读问题")]),_._v(" "),t("ul",[t("li",[t("p",[_._v("快照读（读取记录的可见版本，如普通查询请求：无锁，并发度高）")]),_._v(" "),t("p",[_._v("借助MVCC实现")]),_._v(" "),t("p",[_._v("若读取的数据正在执行删/改操作，读取操作将不会等待该行排它锁的释放，而是直接利用MVVC读取该行的数据快照")]),_._v(" "),t("p",[_._v("MVVC避免了对数据重复加锁的过程，大大提高了读操作的性能")])]),_._v(" "),t("li",[t("p",[_._v("当前读（读取记录的最新版本，如加共享锁（"),t("code",[_._v("in share mode")]),_._v("）/排他锁（"),t("code",[_._v("for update")]),_._v("）的查询请求以及删/改请求）")]),_._v(" "),t("p",[_._v("借助行锁（Next-Key Lock，即Record Lock + Gap Lock）实现")]),_._v(" "),t("blockquote",[t("ul",[t("li",[_._v("批量更新时（出现大量行锁），行锁可能升级为表锁")]),_._v(" "),t("li",[_._v("不根据索引进行查询时，行锁将升级为表锁")])])])])]),_._v(" "),t("h4",{attrs:{id:"最佳实践"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#最佳实践"}},[_._v("#")]),_._v(" 最佳实践")]),_._v(" "),t("ul",[t("li",[_._v("控制事务的大小，减少锁定的资源量和锁的持有时间，提高并发度：在不影响业务逻辑的前提下，尽量将可能持有行锁（可能进行当前读）的请求置于最后执行")])]),_._v(" "),t("blockquote",[t("p",[_._v("（待验证）")]),_._v(" "),t("h6",{attrs:{id:"原子性-借助事务机制实现"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#原子性-借助事务机制实现"}},[_._v("#")]),_._v(" 原子性：借助事务机制实现")]),_._v(" "),t("h6",{attrs:{id:"一致性-借助redo-log-undo-log实现"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#一致性-借助redo-log-undo-log实现"}},[_._v("#")]),_._v(" 一致性：借助redo log + undo log实现")]),_._v(" "),t("h6",{attrs:{id:"隔离性"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#隔离性"}},[_._v("#")]),_._v(" 隔离性")]),_._v(" "),t("h6",{attrs:{id:"持久性-借助redo-log-undo-log实现"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#持久性-借助redo-log-undo-log实现"}},[_._v("#")]),_._v(" 持久性：借助redo log + undo log实现")])]),_._v(" "),t("h3",{attrs:{id:"索引执行成本计算"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#索引执行成本计算"}},[_._v("#")]),_._v(" 索引执行成本计算")]),_._v(" "),t("h5",{attrs:{id:"io成本"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#io成本"}},[_._v("#")]),_._v(" IO成本")]),_._v(" "),t("h5",{attrs:{id:"cpu成本"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#cpu成本"}},[_._v("#")]),_._v(" CPU成本")]),_._v(" "),t("h1",{attrs:{id:"高可用"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#高可用"}},[_._v("#")]),_._v(" 高可用")]),_._v(" "),t("h3",{attrs:{id:"主从配置-mysql-5-7"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#主从配置-mysql-5-7"}},[_._v("#")]),_._v(" 主从配置（MySQL 5.7）")]),_._v(" "),t("h5",{attrs:{id:"master"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#master"}},[_._v("#")]),_._v(" Master")]),_._v(" "),t("div",{staticClass:"language-mysql extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[_._v("GRANT REPLICATION SLAVE ON *.* TO `repl`%`@` IDENTIFIED BY `repl`\nFLUSH PRIVILEGES\nSHOW MASTER STATUS;\n")])])]),t("p",[_._v("记录"),t("code",[_._v("File")]),_._v("及"),t("code",[_._v("Position")]),_._v("变量值")]),_._v(" "),t("h5",{attrs:{id:"slave-docker"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#slave-docker"}},[_._v("#")]),_._v(" Slave（Docker）")]),_._v(" "),t("h6",{attrs:{id:"启动"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#启动"}},[_._v("#")]),_._v(" 启动")]),_._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[_._v("docker run --name mysql5.7_slave --restart always -p "),t("span",{pre:!0,attrs:{class:"token number"}},[_._v("13306")]),_._v(":3306 -v /etc/mysql/slave/my.cnf:/etc/mysql/mysql.conf.d/mysqld.cnf -v /var/lib/mysql/slave:/var/lib/mysql -e "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[_._v("MYSQL_ROOT_PASSWORD")]),t("span",{pre:!0,attrs:{class:"token operator"}},[_._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[_._v('"PASSWORD"')]),_._v(" -d mysql:5.7\n")])])]),t("h6",{attrs:{id:"配置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#配置"}},[_._v("#")]),_._v(" 配置")]),_._v(" "),t("div",{staticClass:"language-mysql extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[_._v("# RESET SLAVE;\n\n# 填入Master端记录的File及Position变量值\nCHANGE MASTER TO MASTER_HOST = 'MASTER_IP', MASTER_PORT = 3306, MASTER_USER = 'repl',\n    MASTER_PASSWORD = 'MASTER_PASSWORD', MASTER_LOG_FILE = 'master-bin.000001', MASTER_LOG_POS = 154;\n\nSTART SLAVE;\n\nSHOW SLAVE STATUS;\n")])])]),t("p",[_._v("查看"),t("code",[_._v("Slave_IO_State")]),_._v("值是否为"),t("code",[_._v("Waiting for master to send event")]),_._v("，"),t("code",[_._v("Slave_IO_Running")]),_._v("与"),t("code",[_._v("Slave_SQL_Running")]),_._v("值是否均为"),t("code",[_._v("Yes")])]),_._v(" "),t("blockquote",[t("p",[_._v("如果有一个值不为"),t("code",[_._v("Yes")]),_._v("，则可能是容器重启后的事务回滚引起的：")]),_._v(" "),t("div",{staticClass:"language-mysq extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[_._v("STOP SLAVE;\nSET GLOBAL SQL_SLAVE_SKIP_COUNTER=1;\nSTART SLAVE;\n")])])])])])}),[],!1,null,null,null);v.default=s.exports}}]);